((function(){var a=Object.prototype.hasOwnProperty,b=function(b,c){function e(){this.constructor=b}for(var d in c)a.call(c,d)&&(b[d]=c[d]);return e.prototype=c.prototype,b.prototype=new e,b.__super__=c.prototype,b};Metro.Store={defaultLimit:100,reservedOperators:{_sort:"_sort",_limit:"_limit"},queryOperators:{">=":"gte",gte:"gte",">":"gt",gt:"gt","<=":"lte",lte:"lte","<":"lt",lt:"lt","in":"in",nin:"nin",any:"any",all:"all","=~":"m",m:"m","!~":"nm",nm:"nm","=":"eq",eq:"eq","!=":"neq",neq:"neq","null":"null",notNull:"notNull"}},Metro.Store.Memory=function(){function a(){this.records={},this.lastId=0}return b(a,Metro.Object),a.prototype.addIndex=function(){var a;return a=Array.prototype.slice.call(arguments,0,arguments.length),this.index[a]=key,this},a.prototype.removeIndex=function(){var a;return a=Array.prototype.slice.call(arguments,0,arguments.length),delete this.index[a],this},a.prototype.find=function(a,b){var c,d,e,f,g,h;g=[],f=this.records;if(Metro.Support.Object.isPresent(a)){h=a._sort,d=a._limit||Metro.Store.defaultLimit;for(c in f)e=f[c],this.matches(e,a)&&g.push(e);h&&(g=this.sort(g,a._sort)),d&&(g=g.slice(0,d-1+1||9e9))}else for(c in f)e=f[c],g.push(e);return b&&b(g),g},a.alias("select","find"),a.prototype.first=function(a,b){var c;return c=this.find(a,function(a){if(b)return b(a[0])}),c[0]},a.prototype.last=function(a,b){var c;return c=this.find(a,function(a){if(b)return b(a[a.length-1])}),c[c.length-1]},a.prototype.all=function(a,b){return this.find(a,b)},a.prototype.length=function(a,b){return this.find(a,function(a){if(b)return b(a.length)}).length},a.alias("count","length"),a.prototype.remove=function(a,b){var c;return c=this.records,this.select(a,function(a){var d,e,f;for(e=0,f=a.length;e<f;e++)d=a[e],c.splice(c.indexOf(d),1);if(b)return b(a)})},a.prototype.clear=function(){return this.records=[]},a.prototype.toArray=function(){return this.records},a.prototype.create=function(a){var b;return a.id||Metro.raise("errors.store.missingAttribute","id","Store#create",a),(b=a.id)==null&&(a.id=this.generateId()),this.records[a.id]=a},a.prototype.update=function(a){return a.id||Metro.raise("errors.store.missingAttribute","id","Store#update",a),this.records[a.id]=a},a.prototype.destroy=function(a){return this.find(id).destroy()},a.prototype.sort=function(){var a;return(a=Metro.Support.Array).sortBy.apply(a,arguments)},a.prototype.matches=function(a,b){var c,d,e,f,g;e=this,f=!0;for(c in b){g=b[c];if(!!Metro.Store.reservedOperators[c])continue;d=a[c],typeof g=="object"?f=e._matchesOperators(a,d,g):(typeof g=="function"&&(g=g.call(a)),f=d===g);if(!f)return!1}return!0},a.prototype.generateId=function(){return this.lastId++},a.prototype._matchesOperators=function(a,b,c){var d,e,f,g,h;g=!0,f=this;for(d in c){h=c[d];if(!(e=Metro.Store.queryOperators[d]))return b===c;typeof h=="function"&&(h=h.call(a));switch(e){case"gt":g=f._isGreaterThan(b,h);break;case"gte":g=f._isGreaterThanOrEqualTo(b,h);break;case"lt":g=f._isLessThan(b,h);break;case"lte":g=f._isLessThanOrEqualTo(b,h);break;case"eq":g=f._isEqualTo(b,h);break;case"neq":g=f._isNotEqualTo(b,h);break;case"m":g=f._isMatchOf(b,h);break;case"nm":g=f._isNotMatchOf(b,h);break;case"any":g=f._anyIn(b,h);break;case"all":g=f._allIn(b,h)}if(!g)return!1}return!0},a.prototype._isGreaterThan=function(a,b){return a&&a>b},a.prototype._isGreaterThanOrEqualTo=function(a,b){return a&&a>=b},a.prototype._isLessThan=function(a,b){return a&&a<b},a.prototype._isLessThanOrEqualTo=function(a,b){return a&&a<=b},a.prototype._isEqualTo=function(a,b){return a===b},a.prototype._isNotEqualTo=function(a,b){return a!==b},a.prototype._isMatchOf=function(a,b){return typeof a=="string"?!!a.match(b):!!a.exec(b)},a.prototype._isNotMatchOf=function(a,b){return typeof a=="string"?!a.match(b):!a.exec(b)},a.prototype._anyIn=function(a,b){var c,d,e;for(d=0,e=b.length;d<e;d++){c=b[d];if(a.indexOf(c)>-1)return!0}return!1},a.prototype._allIn=function(a,b){var c,d;for(c=0,d=array.length;c<d;c++){b=array[c];if(a.indexOf(b)===-1)return!1}return!0},a.prototype.toString=function(){return this.constructor.name},a}()})).call(this)