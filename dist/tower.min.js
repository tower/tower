((function(){var Tower,key,module,specialProperties,_fn,_fn2,_fn3,_fn4,_i,_j,_k,_l,_len,_len2,_len3,_len4,_ref,_ref2,_ref3,_ref4,__slice=Array.prototype.slice,__indexOf=Array.prototype.indexOf||function(a){for(var b=0,c=this.length;b<c;b++)if(b in this&&this[b]===a)return b;return-1},__hasProp=Object.prototype.hasOwnProperty,__extends=function(a,b){function d(){this.constructor=a}for(var c in b)__hasProp.call(b,c)&&(a[c]=b[c]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a},_this=this;window.global||(window.global=window),module=global.module||{},global.Tower=Tower={},Tower.logger=console,Tower.Support={},Tower.Support.Array={extractOptions:function(a){return typeof a[a.length-1]=="object"?a.pop():{}},extractBlock:function(a){return typeof a[a.length-1]=="function"?a.pop():null},args:function(a,b,c,d){b==null&&(b=0),c==null&&(c=!1),d==null&&(d=!1),a=Array.prototype.slice.call(a,b,a.length);if(!c||a.length>=2&&typeof a[a.length-1]=="function")return a;throw new Error("You must pass a callback to the render method")},sortBy:function(a){var b,c,d,e;return d=this.args(arguments,1),c=d[d.length-1]instanceof Array?{}:d.pop(),e=function(a,b){return a>b?1:a<b?-1:0},b=function(a,b){var f,g;return f=[],g=[],d.forEach(function(d){var h,i,j,k;return i=d[0],k=d[1],h=a[i],j=b[i],typeof c[i]!="undefined"&&(h=c[i](h),j=c[i](j)),f.push(k*e(h,j)),g.push(k*e(j,h))}),f<g?-1:1},d=d.map(function(a){return a instanceof Array||(a=[a,"asc"]),a[1]==="desc"?a[1]=-1:a[1]=1,a}),a.sort(function(a,c){return b(a,c)})}},Tower.Support.Callbacks={ClassMethods:{before:function(){return this.appendCallback.apply(this,["before"].concat(__slice.call(arguments)))},after:function(){return this.appendCallback.apply(this,["after"].concat(__slice.call(arguments)))},callback:function(){var a;return a=Tower.Support.Array.args(arguments),a[0].match(/^(?:before|around|after)$/)||(a=["after"].concat(a)),this.appendCallback.apply(this,a)},removeCallback:function(a,b,c){return this},appendCallback:function(a){var b,c,d,e,f,g,h,i;b=Tower.Support.Array.args(arguments,1),typeof b[b.length-1]!="object"&&(f=b.pop()),typeof b[b.length-1]=="object"&&(g=b.pop()),f||(f=b.pop()),g||(g={}),d=this.callbacks();for(h=0,i=b.length;h<i;h++)e=b[h],c=d[e]||(d[e]=new Tower.Support.Callbacks.Chain),c.push(a,f,g);return this},prependCallback:function(a,b,c,d){return d==null&&(d={}),this},callbacks:function(){return this._callbacks||(this._callbacks={})}},runCallbacks:function(a,b,c,d){var e;typeof b=="function"&&(d=c,c=b,b={}),b||(b={}),e=this.constructor.callbacks()[a];if(e)return e.run(this,b,c,d);c.call(this);if(d)return d.call(this)},_callback:function(){var a,b=this;return a=1<=arguments.length?__slice.call(arguments,0):[],function(c){var d,e,f,g;g=[];for(e=0,f=a.length;e<f;e++)d=a[e],d?g.push(d.call(b,c)):g.push(void 0);return g}}},Tower.Support.Callbacks.Chain=function(){function a(a){var b,c;a==null&&(a={});for(b in a)c=a[b],this[b]=c;this.before||(this.before=[]),this.after||(this.after=[])}return a.prototype.run=function(a,b,c,d){var e,f=this;return e=function(c,d){return c.run(a,b,d)},Tower.async(this.before,e,function(b){if(!b){if(!c)return Tower.async(f.after,e,function(b){return d&&d.call(a),a});switch(c.length){case 0:return c.call(a),Tower.async(f.after,e,function(b){return d&&d.call(a),a});default:return c.call(a,function(b){if(!b)return Tower.async(f.after,e,function(b){return d&&d.call(a),a})})}}})},a.prototype.push=function(a,b,c,d){return this[a].push(new Tower.Support.Callback(b,c,d))},a}(),Tower.Support.Callback=function(){function a(a,b){b==null&&(b={}),this.method=a,this.conditions=b,b.hasOwnProperty("only")&&(b.only=Tower.Support.Object.toArray(b.only)),b.hasOwnProperty("except")&&(b.except=Tower.Support.Object.toArray(b.except))}return a.prototype.run=function(a,b,c){var d,e,f;d=this.conditions;if(b&&b.hasOwnProperty("name"))if(d.hasOwnProperty("only")){if(_.indexOf(d.only,b.name)===-1)return c()}else if(d.hasOwnProperty("except")&&_.indexOf(d.except,b.name)!==-1)return c();e=this.method,typeof e=="string"&&(e=a[e]);switch(e.length){case 0:return f=e.call(a),c(f?null:new Error("Callback did not pass"));default:return e.call(a,c)}},a}(),specialProperties=["included","extended","prototype","ClassMethods","InstanceMethods"],Tower.Class=function(){function a(){this.initialize()}return a.global=function(a){return a!==void 0&&(this._global=a),this._global===void 0&&(this._global=!0),a===!0?global[this.name]=this:a===!1&&delete global[this.name],this._global},a.alias=function(a,b){return Tower.Support.Object.alias(this.prototype,a,b)},a.accessor=function(a,b){return Tower.Support.Object.accessor(this.prototype,a,b),this},a.getter=function(a,b){return Tower.Support.Object.getter(this.prototype,a,b),this},a.setter=function(a){return Tower.Support.Object.setter(this.prototype,a),this},a.classAlias=function(a,b){return Tower.Support.Object.alias(this,a,b),this},a.classAccessor=function(a,b){return Tower.Support.Object.accessor(this,a,b),this},a.classGetter=function(a,b){return Tower.Support.Object.getter(this,a,b),this},a.classSetter=function(a){return Tower.Support.Object.setter(this,a),this},a.classEval=function(a){return a.call(this)},a.delegate=function(a,b){return b==null&&(b={}),Tower.Support.Object.delegate(this.prototype,a,b),this},a.mixin=function(a,b){var c,d;for(c in b)d=b[c],__indexOf.call(specialProperties,c)<0&&(a[c]=d);return b},a.extend=function(a){var b;return this.mixin(this,a),b=a.extended,b&&b.apply(a),a},a.self=function(a){return this.extend(a)},a.include=function(a){var b;return a.hasOwnProperty("ClassMethods")&&this.extend(a.ClassMethods),a.hasOwnProperty("InstanceMethods")&&this.include(a.InstanceMethods),this.mixin(this.prototype,a),b=a.included,b&&b.apply(a),a},a.className=function(){return Tower.Support.Object.functionName(this)},a.prototype.className=function(){return this.constructor.className()},a.prototype.initialize=function(){},a}(),Tower.Support.EventEmitter={isEventEmitter:!0,events:function(){return this._events||(this._events={})},hasEventListener:function(a){return Tower.Support.Object.isPresent(this.events(),a)},event:function(a){var b;return(b=this.events())[a]||(b[a]=new Tower.Event(this,a))},on:function(){var a,b,c,d,e,f;a=Tower.Support.Array.args(arguments),typeof a[a.length-1]=="object"?(e=a.pop(),a.length===0&&(b=e,e={})):e={},typeof a[a.length-1]=="object"?b=a.pop():(b={},b[a.shift()]=a.shift()),f=[];for(c in b)d=b[c],f.push(this.addEventHandler(c,d,e));return f},addEventHandler:function(a,b,c){return this.event(a).addHandler(b)},mutation:function(a){return function(){var b;return b=a.apply(this,arguments),this.event("change").fire(this,this),b}},prevent:function(a){return this.event(a).prevent(),this},allow:function(a){return this.event(a).allow(),this},isPrevented:function(a){return this.event(a).isPrevented()},fire:function(a){var b;return b=this.event(a),b.fire.call(b,Tower.Support.Array.args(arguments,1))},allowAndFire:function(a){return this.event(a).allowAndFire(Tower.Support.Array.args(arguments,1))}},Tower.Support.I18n={PATTERN:/(?:%%|%\{(\w+)\}|%<(\w+)>(.*?\d*\.?\d*[bBdiouxXeEfgGcps]))/g,defaultLanguage:"en",load:function(a,b){var c;return b==null&&(b=this.defaultLanguage),c=this.store(),b=c[b]||(c[b]={}),Tower.Support.Object.deepMerge(b,typeof a=="string"?require(a):a),this},translate:function(a,b){b==null&&(b={}),b.hasOwnProperty("tense")&&(a+="."+b.tense);if(b.hasOwnProperty("count"))switch(b.count){case 0:a+=".none";break;case 1:a+=".one";break;default:a+=".other"}return this.interpolate(this.lookup(a,b.language),b)},localize:function(){return this.translate.apply(this,arguments)},lookup:function(a,b){var c,d,e,f,g;b==null&&(b=this.defaultLanguage),d=a.split("."),e=this.store()[b];try{for(f=0,g=d.length;f<g;f++)c=d[f],e=e[c]}catch(h){e=null}if(e==null)throw new Error("Translation doesn't exist for '"+a+"'");return e},store:function(){return this._store||(this._store={})},interpolate:function(a,b){return b==null&&(b={}),a.replace(this.PATTERN,function(a,c,d,e){var f,g;if(a==="%%")return"%";f=c||d;if(b.hasOwnProperty(f))g=b[f];else throw new Error("Missing interpolation argument "+f);return typeof g=="function"&&(g=g.call(b)),e?sprintf("%"+e,g):g})}},Tower.Support.I18n.t=Tower.Support.I18n.translate,Tower.Support.Number={isInt:function(a){return a===+a&&a===(a|0)},isFloat:function(a){return a===+a&&a!==(a|0)}},specialProperties=["included","extended","prototype","ClassMethods","InstanceMethods"],Tower.Support.Object={extend:function(a){var b,c,d,e,f,g;b=Tower.Support.Array.args(arguments,1);for(f=0,g=b.length;f<g;f++){d=b[f];for(c in d)e=d[c],__indexOf.call(specialProperties,c)<0&&(a[c]=e)}return a},cloneHash:function(a){var b,c,d;c={};for(b in a)d=a[b],this.isArray(d)?c[b]=this.cloneArray(d):this.isHash(d)?c[b]=this.cloneHash(d):c[b]=d;return c},cloneArray:function(a){var b,c,d,e;d=a.concat();for(b=0,e=d.length;b<e;b++)c=d[b],this.isArray(c)?d[b]=this.cloneArray(c):this.isHash(c)&&(d[b]=this.cloneHash(c));return d},deepMerge:function(a){var b,c,d,e,f,g;b=Tower.Support.Array.args(arguments,1);for(f=0,g=b.length;f<g;f++){d=b[f];for(c in d)e=d[c],__indexOf.call(specialProperties,c)<0&&(a[c]&&typeof e=="object"?a[c]=Tower.Support.Object.deepMerge(a[c],e):a[c]=e)}return a},deepMergeWithArrays:function(a){var b,c,d,e,f,g,h;b=Tower.Support.Array.args(arguments,1);for(g=0,h=b.length;g<h;g++){d=b[g];for(c in d){f=d[c];if(__indexOf.call(specialProperties,c)<0)e=a[c],e?this.isArray(e)?a[c]=e.concat(f):typeof e=="object"&&typeof f=="object"?a[c]=Tower.Support.Object.deepMergeWithArrays(a[c],f):a[c]=f:a[c]=f;else continue}}return a},defineProperty:function(a,b,c){return c==null&&(c={}),Object.defineProperty(a,b,c)},functionName:function(a){var b;return a.__name__?a.__name__:a.name?a.name:(b=a.toString().match(/\W*function\s+([\w\$]+)\(/))!=null?b[1]:void 0},alias:function(a,b,c){return a[b]=a[c]},accessor:function(a,b,c){return a._accessors||(a._accessors=[]),a._accessors.push(b),this.getter(b,a,c),this.setter(b,a),this},setter:function(a,b){return a.hasOwnProperty("_setAttribute")||this.defineProperty(a,"_setAttribute",{enumerable:!1,configurable:!0,value:function(a,b){return this["_"+a]=b}}),a._setters||(a._setters=[]),a._setters.push(b),this.defineProperty(a,b,{enumerable:!0,configurable:!0,set:function(a){return this._setAttribute(b,a)}}),this},getter:function(a,b,c){return a.hasOwnProperty("_getAttribute")||this.defineProperty(a,"_getAttribute",{enumerable:!1,configurable:!0,value:function(a){return this["_"+a]}}),a._getters||(a._getters=[]),a._getters.push(b),this.defineProperty(a,b,{enumerable:!0,configurable:!0,get:function(){return this._getAttribute(b)||(c?this["_"+b]=c.apply(this):void 0)}}),this},variables:function(a){},accessors:function(a){},methods:function(a){var b,c,d;c=[];for(b in a)d=a[b],this.isFunction(d)&&c.push(b);return c},delegate:function(){var a,b,c,d,e,f,g,h,i;d=arguments[0],c=3<=arguments.length?__slice.call(arguments,1,g=arguments.length-1):(g=1,[]),e=arguments[g++],e==null&&(e={}),f=e.to,a=this.isFunction(d);for(h=0,i=c.length;h<i;h++)b=c[h],a?d[b]=function(){var a;return(a=this[f]())[b].apply(a,arguments)}:this.defineProperty(d,b,{enumerable:!0,configurable:!0,get:function(){return this[f]()[b]}});return d},isFunction:function(a){return!!(a&&a.constructor&&a.call&&a.apply)},toArray:function(a){return this.isArray(a)?a:[a]},keys:function(a){return Object.keys(a)},isA:function(a,b){},isRegExp:function(a){return!(!(a&&a.test&&a.exec)||!a.ignoreCase&&a.ignoreCase!==!1)},isHash:function(a){return this.isObject(a)&&!(this.isFunction(a)||this.isArray(a)||_.isDate(a)||_.isRegExp(a))},isBaseObject:function(a){return a&&a.constructor&&a.constructor.name==="Object"},isArray:Array.isArray||function(a){return toString.call(a)==="[object Array]"},kind:function(a){var b;b=typeof a;switch(b){case"object":if(_.isArray(a))return"array";if(_.isArguments(a))return"arguments";if(_.isBoolean(a))return"boolean";if(_.isDate(a))return"date";if(_.isRegExp(a))return"regex";if(_.isNaN(a))return"NaN";if(_.isNull(a))return"null";if(_.isUndefined(a))return"undefined";return"object";case"number":if(a===+a&&a===(a|0))return"integer";if(a===+a&&a!==(a|0))return"float";return"number";case"function":if(_.isRegExp(a))return"regex";return"function";default:return b}},isObject:function(a){return a===Object(a)},isPresent:function(a){return!this.isBlank(a)},isBlank:function(a){var b,c;if(typeof a=="string")return a==="";for(b in a)return c=a[b],!1;return!0},has:function(a,b){return a.hasOwnProperty(b)}},Tower.Support.RegExp={regexpEscape:function(a){return a.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&")}},Tower.Support.String={camelize_rx:/(?:^|_|\-)(.)/g,capitalize_rx:/(^|\s)([a-z])/g,underscore_rx1:/([A-Z]+)([A-Z][a-z])/g,underscore_rx2:/([a-z\d])([A-Z])/g,parameterize:function(a){return Tower.Support.String.underscore(a).replace("_","-")},constantize:function(a,b){return b==null&&(b=global),b[this.camelize(a)]},camelize:function(a,b){return a=a.replace(this.camelize_rx,function(a,b){return b.toUpperCase()}),b?a.substr(0,1).toLowerCase()+a.substr(1):a},underscore:function(a){return a.replace(this.underscore_rx1,"$1_$2").replace(this.underscore_rx2,"$1_$2").replace("-","_").toLowerCase()},singularize:function(a){var b;return b=a.length,a.substr(b-3)==="ies"?a.substr(0,b-3)+"y":a.substr(b-1)==="s"?a.substr(0,b-1):a},pluralize:function(a,b){var c,d;if(b){if(a===1)return b}else b=a;return d=b.length,c=b.substr(d-1),c==="y"?""+b.substr(0,d-1)+"ies":c==="s"?b:""+b+"s"},capitalize:function(a){return a.replace(this.capitalize_rx,function(a,b,c){return b+c.toUpperCase()})},trim:function(a){return a?a.trim():""},interpolate:function(a,b){var c,d,e;typeof a=="object"?(d=a[b.count],d||(d=a.other)):d=a;for(c in b)e=b[c],d=d.replace(new RegExp("%\\{"+c+"\\}","g"),e);return d}},Tower.Support.String.toQueryValue=function(a,b){var c,d,e,f,g;b==null&&(b="");if(Tower.Support.Object.isArray(a)){d=[];for(f=0,g=a.length;f<g;f++)c=a[f],e=b,e+=c,d.push(e);e=d.join(",")}else e=b,e+=a.toString();return e=e.replace(" ","+").replace(/[#%\"\|<>]/g,function(a){return encodeURIComponent(a)}),e},Tower.Support.String.toQuery=function(a,b){var c,d,e,f,g,h,i,j,k;b==null&&(b={}),h=[];for(d in a)k=a[d],f=""+d+"=",j=b[d]||"string",e=j==="string"?"-":"^",Tower.Support.Object.isHash(k)?(c={},k.hasOwnProperty(">=")&&(c.min=k[">="]),k.hasOwnProperty(">")&&(c.min=k[">"]),k.hasOwnProperty("<=")&&(c.max=k["<="]),k.hasOwnProperty("<")&&(c.max=k["<"]),k.hasOwnProperty("=~")&&(c.match=k["=~"]),k.hasOwnProperty("!~")&&(c.notMatch=k["!~"]),k.hasOwnProperty("==")&&(c.eq=k["=="]),k.hasOwnProperty("!=")&&(c.neq=k["!="]),c.range=c.hasOwnProperty("min")||c.hasOwnProperty("max"),i=[],c.range&&!c.hasOwnProperty("eq")&&!c.hasOwnProperty("match")&&(g="",c.hasOwnProperty("min")?g+=Tower.Support.String.toQueryValue(c.min):g+="n",g+="..",c.hasOwnProperty("max")?g+=Tower.Support.String.toQueryValue(c.max):g+="n",i.push(g)),c.hasOwnProperty("eq")&&i.push(Tower.Support.String.toQueryValue(c.eq)),c.hasOwnProperty("match")&&i.push(Tower.Support.String.toQueryValue(c.match)),c.hasOwnProperty("neq")&&i.push(Tower.Support.String.toQueryValue(c.neq,e)),c.hasOwnProperty("notMatch")&&i.push(Tower.Support.String.toQueryValue(c.notMatch,e)),f+=i.join(",")):f+=Tower.Support.String.toQueryValue(k),h.push(f);return h.sort().join("&")},Tower.Support.String.extractDomain=function(a,b){var c;return b==null&&(b=1),this.namedHost(a)?(c=a.split("."),c.slice(0,c.length-1-1+b+1||9e9).join(".")):null},Tower.Support.String.extractSubdomains=function(a,b){var c;return b==null&&(b=1),this.namedHost(a)?(c=a.split("."),c.slice(0,-(b+2)+1||9e9)):[]},Tower.Support.String.extractSubdomain=function(a,b){return b==null&&(b=1),this.extractSubdomains(a,b).join(".")},Tower.Support.String.namedHost=function(a){return a!==null&&!/\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/.exec(a)},Tower.Support.String.rewriteAuthentication=function(a){return a.user&&a.password?""+encodeURI(a.user)+":"+encodeURI(a.password)+"@":""},Tower.Support.String.hostOrSubdomainAndDomain=function(a){var b,c,d;return a.subdomain===null&&a.domain===null?a.host:(d=a.tldLength||1,b="",a.subdomain!==!1&&(c=a.subdomain||this.extractSubdomain(a.host,d),c&&(b+=""+c+".")),b+=a.domain||this.extractDomain(a.host,d),b)},Tower.Support.String.urlFor=function(a){var b,c,d,e,f;if(!a.host&&!a.onlyPath)throw new Error("Missing host to link to! Please provide the :host parameter, set defaultUrlOptions[:host], or set :onlyPath to true");return e="",b=a.params||{},c=(a.path||"").replace(/\/+/,"/"),f=a.schema||{},delete a.path,delete a.schema,a.onlyPath||(d=a.port,delete a.port,a.protocol!==!1&&(e+=a.protocol||"http",e.match(Tower.Support.RegExp.regexpEscape(":|//"))||(e+=":")),e.match("//")||(e+="//"),e+=this.rewriteAuthentication(a),e+=this.hostOrSubdomainAndDomain(a),d&&(e+=":"+d)),a.trailingSlash?e+=c.replace(/\/$/,"/"):e+=c,Tower.Support.Object.isBlank(b)||(e+="?"+Tower.Support.String.toQuery(b,f)),a.anchor&&(e+="#"+Tower.Support.String.toQuery(a.anchor)),e},Tower.urlFor=function(){var a,b,c,d,e,f,g,h;a=Tower.Support.Array.args(arguments);if(!a[0])return null;if(a[0]instanceof Tower.Model||(typeof a[0]).match(/(string|function)/))c=a[a.length-1],c instanceof Tower.Model||(typeof c).match(/(string|function)/)?d={}:d=a.pop();d||(d=a.pop()),e="";if(d.controller&&d.action)f=Tower.Route.find({name:Tower.Support.String.camelize(d.controller).replace(/(Controller)?$/,"Controller"),action:d.action}),f&&(e="/"+Tower.Support.String.parameterize(d.controller));else for(g=0,h=a.length;g<h;g++)b=a[g],e+="/",typeof b=="string"?e+=b:b instanceof Tower.Model?e+=b.toPath():typeof b=="function"&&(e+=b.toParam());return e+=function(){switch(d.action){case"new":return"/new";case"edit":return"/edit";default:return""}}(),d.hasOwnProperty("onlyPath")||(d.onlyPath=!0),d.path=e,Tower.Support.String.urlFor(d)},Tower.Support.String.parameterize=function(a){return Tower.Support.String.underscore(a).replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"-").replace(/^-+|-+$/g,"")},Tower.Support.Url={},Tower.Support.I18n.load({date:{formats:{"default":"%Y-%m-%d","short":"%b %d","long":"%B %d, %Y"},dayNames:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],abbrDayNames:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],monthNames:[null,"January","February","March","April","May","June","July","August","September","October","November","December"],abbrMonthNames:[null,"Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],order:["year","month","day"]}}),{time:{formats:{"default":"%a, %d %b %Y %H:%M:%S %z","short":"%d %b %H:%M","long":"%B %d, %Y %H:%M"},am:"am",pm:"pm"},support:{array:{wordsConnector:", ",twoWordsConnector:" and ",lastWordConnector:", and "}}},Tower.Hook=function(a){function b(){b.__super__.constructor.apply(this,arguments)}return __extends(b,a),b.include(Tower.Support.Callbacks),b}(Tower.Class),Tower.Engine=function(a){function b(){b.__super__.constructor.apply(this,arguments)}return __extends(b,a),b}(Tower.Hook),Tower.Support.Object.extend(Tower,{env:"development",port:3e3,version:"0.3.0",client:typeof window!="undefined",root:"/",publicPath:"/","case":"camelcase",namespace:null,accessors:typeof window=="undefined",logger:typeof _console!="undefined"?_console:console,structure:"standard",config:{},namespaces:{},metadata:{},metadataFor:function(a){var b;return(b=this.metadata)[a]||(b[a]={})},callback:function(){var a;return(a=Tower.Application).callback.apply(a,arguments)},runCallbacks:function(){var a;return(a=Tower.Application.instance()).runCallbacks.apply(a,arguments)},sync:function(a,b,c){if(c)return c(null,b)},get:function(){return Tower.request.apply(Tower,["get"].concat(__slice.call(arguments)))},post:function(){return Tower.request.apply(Tower,["post"].concat(__slice.call(arguments)))},put:function(){return Tower.request.apply(Tower,["put"].concat(__slice.call(arguments)))},destroy:function(){return Tower.request.apply(Tower,["delete"].concat(__slice.call(arguments)))},request:function(a,b,c,d){var e,f,g,h;return typeof c=="function"&&(d=c,c={}),c||(c={}),h=b,e=new Tower.Dispatch.Url(h),f=new Tower.Dispatch.Request({url:h,location:e,method:a}),g=new Tower.Dispatch.Response({url:h,location:e,method:a}),f.query=e.params,Tower.Application.instance().handle(f,g,function(){return d.call(this,this.response)})},raise:function(){throw new Error(Tower.t.apply(Tower,arguments))},t:function(){var a;return(a=Tower.Support.I18n).translate.apply(a,arguments)},l:function(){var a;return(a=Tower.Support.I18n).localize.apply(a,arguments)},stringify:function(){var a;a=Tower.Support.Array.args(arguments).join("_");switch(Tower["case"]){case"snakecase":return Tower.Support.String.underscore(a);default:return Tower.Support.String.camelcase(a)}},namespace:function(){return Tower.Application.instance().constructor.name},module:function(a){var b,c,d,e,f;b=Tower.namespaces[a];if(b)return b;d=a.split("."),b=Tower;for(e=0,f=d.length;e<f;e++)c=d[e],b=b[c]||(b[c]={});return Tower.namespaces[a]=b},constant:function(a){var b,c,d,e,f,g;c=global,e=a.split(".");try{for(f=0,g=e.length;f<g;f++)d=e[f],c=c[d]}catch(h){c=null}if(!c){b=Tower.namespace();if(b&&e[0]!==b)c=Tower.constant(""+b+"."+a);else throw new Error("Constant '"+a+"' wasn't found")}return c},namespaced:function(a){var b;return b=Tower.namespace(),b?""+b+"."+a:a},async:function(a,b,c){var d,e;return a.length?(d=0,e=function(){return b(a[d],function(b){return b?(c(b),c=function(){}):(d+=1,d===a.length?c():e())})},e()):c()}}),Tower.client&&(Tower.request=function(a,b,c,d){var e;return typeof c=="function"&&(d=c,c={}),c||(c={}),e=b,History.pushState(null,null,e)}),_.mixin(_.string.exports()),$("a").click(function(){return History.pushState(null,null,$(this).attr("href")),!1}),Tower.Application=function(a){function b(a){var b,c,d,e;a==null&&(a=[]);if(Tower.Application._instance)throw new Error("Already initialized application");Tower.Application._instance=this,(c=Tower.Application).middleware||(c.middleware=[]),this.io=global.io,this.History=global.History,this.stack=[];for(d=0,e=a.length;d<e;d++)b=a[d],this.use(b)}return __extends(b,a),b.configure=function(a){return this.initializers().push(a)},b.initializers=function(){return this._initializers||(this._initializers=[])},b.instance=function(){return this._instance},b.defaultStack=function(){return this.use(Tower.Middleware.Location),this.use(Tower.Middleware.Router),this.middleware},b.use=function(){return this.middleware||(this.middleware=[]),this.middleware.push(arguments)},b.prototype.use=function(){var a;return(a=this.constructor).use.apply(a,arguments)},b.prototype.initialize=function(){return this.extractAgent(),this.applyMiddleware(),this},b.prototype.applyMiddleware=function(){var a,b,c,d,e;b=this.constructor.middleware,b&&b.length>0||(b=this.constructor.defaultStack()),e=[];for(c=0,d=b.length;c<d;c++)a=b[c],e.push(this.middleware.apply(this,a));return e},b.prototype.middleware=function(){var a,b,c;return a=Tower.Support.Array.args(arguments),c="/",b=a.pop(),typeof c!="string"&&(b=c,c="/"),"/"===c[c.length-1]&&(c=c.substr(0,c.length-1)),this.stack.push({route:c,handle:b}),this},b.prototype.extractAgent=function(){return Tower.cookies=Tower.Dispatch.Cookies.parse(),Tower.agent=new Tower.Dispatch.Agent(JSON.parse(Tower.cookies["user-agent"]||"{}"))},b.prototype.listen=function(){var a;a=this;if(this.listening)return;return this.listening=!0,this.History&&this.History.enabled?(this.History.Adapter.bind(global,"statechange",function(){var b,c,d,e;return e=History.getState(),b=new Tower.Dispatch.Url(e.url),c=new Tower.Dispatch.Request({url:e.url,location:b,params:Tower.Support.Object.extend({title:e.title},e.data||{})}),d=new Tower.Dispatch.Response({url:e.url,location:b}),a.handle(c,d)}),$(global).trigger("statechange")):console.warn("History not enabled")},b.prototype.run=function(){return this.listen()},b.prototype.handle=function(a,b,c){var d,e,f,g,h,i;return d=Tower.env,f=function(g){var i,j,k,l,m,n;k=void 0,m=void 0,j=void 0,a.url=n+a.url,a.originalUrl=a.originalUrl||a.url,n="",k=h[e++];if(!k||b.headerSent){if(c)return c(g);if(g){l="production"===d?"Internal Server Error":g.stack||g.toString(),"test"!==d&&console.error(g.stack||g.toString());if(b.headerSent)return a.socket.destroy();b.statusCode=500,b.setHeader("Content-Type","text/plain"),b.end(l)}else b.statusCode=404,b.setHeader("Content-Type","text/plain"),b.end("Cannot "+a.method+" "+a.url);return}try{return m=a.location.path,undefined===m&&(m="/"),0!==m.indexOf(k.route)?f(g):(j=m[k.route.length],j&&"/"!==j&&"."!==j?f(g):(n=k.route,a.url=a.url.substr(n.length),"/"!==a.url[0]&&(a.url="/"+a.url),i=k.handle.length,g?i===4?k.handle(g,a,b,f):f(g):i<4?k.handle(a,b,f):f()))}catch(o){return f(o)}},i=b.writeHead,h=this.stack,g="",e=0,f()},b}(Tower.Engine),Tower.Store=function(a){function b(a){a==null&&(a={}),this.name=a.name,this.className=a.type||Tower.namespaced(Tower.Support.String.camelize(Tower.Support.String.singularize(this.name)))}return __extends(b,a),b.include(Tower.Support.Callbacks),b.defaultLimit=100,b.isKeyword=function(a){return this.queryOperators.hasOwnProperty(a)||this.atomicModifiers.hasOwnProperty(a)},b.hasKeyword=function(a){var b,c;return!function(){var d,e;d=this.queryOperators,e=[];for(b in d)c=d[b],e.push(a.hasOwnProperty(b));return e}.call(this)?!function(){var d,e;d=this.atomicModifiers,e=[];for(b in d)c=d[b],e.push(a.hasOwnProperty(b));return e}.call(this)?!1:!0:!0},b.atomicModifiers={$set:"$set",$unset:"$unset",$push:"$push",$pushAll:"$pushAll",$pull:"$pull",$pullAll:"$pullAll",$inc:"$inc",$pop:"$pop"},b.queryOperators={">=":"$gte",$gte:"$gte",">":"$gt",$gt:"$gt","<=":"$lte",$lte:"$lte","<":"$lt",$lt:"$lt",$in:"$in",$any:"$in",$nin:"$nin",$all:"$all","=~":"$regex",$m:"$regex",$regex:"$regex",$match:"$match",$notMatch:"$notMatch","!~":"$nm",$nm:"$nm","=":"$eq",$eq:"$eq","!=":"$neq",$neq:"$neq",$null:"$null",$notNull:"$notNull"},b.booleans={"true":!0,"true":!0,TRUE:!0,1:!0,1:!0,1:!0,"false":!1,"false":!1,FALSE:!1,0:!1,0:!1,0:!1},b.prototype.serialize=function(a){var b,c,d;for(b=0,d=a.length;b<d;b++)c=a[b],a[b]=this.serializeModel(c);return a},b.prototype.deserialize=function(a){var b,c,d;for(b=0,d=a.length;b<d;b++)c=a[b],a[b]=this.deserializeModel(c);return a},b.prototype.serializeModel=function(a){var b;return a instanceof Tower.Model?a:(b=Tower.constant(this.className),new b(a))},b.prototype.deserializeModel=function(a){return a instanceof Tower.Model?a.attributes:a},b.prototype._defaultOptions=function(a){return a},b.prototype.load=function(a){},b.prototype.fetch=function(){},b.prototype.schema=function(){return Tower.constant(this.className).fields()},b}(Tower.Class),Tower.Store.Memory=function(a){function b(a){b.__super__.constructor.call(this,a),this.initialize()}return __extends(b,a),b.stores=function(){return this._stores||(this._stores=[])},b.clear=function(){var a,b,c,d;b=this.stores();for(c=0,d=b.length;c<d;c++)a=b[c],a.clear();return this._stores.length=0,this._stores},b.prototype.initialize=function(){return this.constructor.stores().push(this),this.records={},this.lastId=0},b}(Tower.Store),Tower.Store.Memory.Finders={find:function(a,b,c){var d,e,f,g,h,i;h=[],g=this.records;if(Tower.Support.Object.isPresent(a)){i=b.sort,e=b.limit||Tower.Store.defaultLimit;for(d in g)f=g[d],this.matches(f,a)&&h.push(f);i&&(h=this.sort(h,i)),e&&(h=h.slice(0,e-1+1||9e9))}else for(d in g)f=g[d],h.push(f);return c&&c.call(this,null,h),h},findOne:function(a,b,c){var d,e=this;return d=null,b.limit=1,this.find(a,b,function(a,b){d=b[0]||null;if(c)return c.call(e,a,d)}),d},count:function(a,b,c){var d,e=this;return d=0,this.find(a,b,function(a,b){d=b.length;if(c)return c.call(e,a,d)}),d},exists:function(a,b,c){var d,e=this;return d=!1,this.count(a,b,function(a,b){d=!!b;if(c)return c.call(e,a,d)}),d},sort:function(a,b){var c;return(c=Tower.Support.Array).sortBy.apply(c,[a].concat(__slice.call(b)))},matches:function(a,b){var c,d,e,f,g,h;f=this,g=!0,e=this.schema();for(c in b){h=b[c],d=a.get(c),Tower.Support.Object.isRegExp(h)?g=d.match(h):typeof h=="object"?g=f._matchesOperators(a,d,h):(typeof h=="function"&&(h=h.call(a)),g=d===h);if(!g)return!1}return!0},_matchesOperators:function(a,b,c){var d,e,f,g,h;g=!0,f=this;for(d in c){h=c[d];if(!(e=Tower.Store.queryOperators[d]))return b===c;_.isFunction(h)&&(h=h.call(a));switch(e){case"$in":case"$any":g=f._anyIn(b,h);break;case"$nin":g=f._notIn(b,h);break;case"$gt":g=f._isGreaterThan(b,h);break;case"$gte":g=f._isGreaterThanOrEqualTo(b,h);break;case"$lt":g=f._isLessThan(b,h);break;case"$lte":g=f._isLessThanOrEqualTo(b,h);break;case"$eq":g=f._isEqualTo(b,h);break;case"$neq":g=f._isNotEqualTo(b,h);break;case"$regex":case"$match":g=f._isMatchOf(b,h);break;case"$notMatch":g=f._isNotMatchOf(b,h);break;case"$all":g=f._allIn(b,h)}if(!g)return!1}return!0},_isGreaterThan:function(a,b){return a&&a>b},_isGreaterThanOrEqualTo:function(a,b){return a&&a>=b},_isLessThan:function(a,b){return a&&a<b},_isLessThanOrEqualTo:function(a,b){return a&&a<=b},_isEqualTo:function(a,b){return a===b},_isNotEqualTo:function(a,b){return a!==b},_isMatchOf:function(a,b){return typeof a=="string"?!!a.match(b):!!a.exec(b)},_isNotMatchOf:function(a,b){return typeof a=="string"?!a.match(b):!a.exec(b)},_anyIn:function(a,b){var c,d,e,f,g;if(_.isArray(a))for(d=0,f=b.length;d<f;d++){c=b[d];if(a.indexOf(c)>-1)return!0}else for(e=0,g=b.length;e<g;e++){c=b[e];if(a===c)return!0}return!1},_notIn:function(a,b){var c,d,e,f,g;if(_.isArray(a))for(d=0,f=b.length;d<f;d++){c=b[d];if(a.indexOf(c)>-1)return!1}else for(e=0,g=b.length;e<g;e++){c=b[e];if(a===c)return!1}return!0},_allIn:function(a,b){var c,d,e,f,g;if(_.isArray(a))for(d=0,f=b.length;d<f;d++){c=b[d];if(a.indexOf(c)===-1)return!1}else for(e=0,g=b.length;e<g;e++){c=b[e];if(a!==c)return!1}return!0}},Tower.Store.Memory.Persistence={load:function(a){var b,c,d,e;c=Tower.Support.Object.toArray(a);for(d=0,e=c.length;d<e;d++)b=c[d],this.loadOne(this.serializeModel(b));return c},loadOne:function(a){return this.records[a.get("id").toString()]=a},create:function(a,b,c){var d,e,f,g;e=null;if(Tower.Support.Object.isArray(a)){e=[];for(f=0,g=a.length;f<g;f++)d=a[f],e.push(this.createOne(d))}else e=this.createOne(a);return c&&c.call(this,null,e),e},createOne:function(a){var b;return b=this.deserializeModel(a),b.id==null&&(b.id=this.generateId().toString()),this.loadOne(this.serializeModel(a))},update:function(a,b,c,d){var e=this;return this.find(b,c,function(b,c){var f,g,h;if(b)return d(b);for(g=0,h=c.length;g<h;g++)f=c[g],e.updateOne(f,a);return d.call(e,b,c),c})},updateOne:function(a,b){var c,d;for(c in b)d=b[c],this._updateAttribute(a.attributes,c,d);return a},destroy:function(a,b,c){return this.find(a,b,function(a,b){var d,e,f;if(a)return c(a);for(e=0,f=b.length;e<f;e++)d=b[e],this.destroyOne(d);return c&&c.call(this,a,b),b})},destroyOne:function(a){return delete this.records[a.get("id").toString()]}},Tower.Store.Memory.Serialization={generateId:function(){return this.lastId++},_updateAttribute:function(a,b,c){var d;return d=this.schema()[b],d&&d.type==="Array"&&!Tower.Support.Object.isArray(c)?(a[b]||(a[b]=[]),a[b].push(c)):this._atomicModifier(b)?this["_"+b.replace("$","")+"AtomicUpdate"](a,c):a[b]=c},_atomicModifier:function(a){return!!this.constructor.atomicModifiers[a]},_pushAtomicUpdate:function(a,b){var c,d;for(c in b)d=b[c],a[c]||(a[c]=[]),a[c].push(d);return a},_pullAtomicUpdate:function(a,b){var c,d,e,f,g,h;for(f in b){h=b[f],d=a[f];if(d)for(e=0,g=h.length;e<g;e++)c=h[e],d.splice(d.indexOf(c),1)}return a},_incAtomicUpdate:function(a,b){var c,d;for(c in b)d=b[c],a[c]||(a[c]=0),a[c]+=d;return a}},Tower.Store.Memory.include(Tower.Store.Memory.Finders),Tower.Store.Memory.include(Tower.Store.Memory.Persistence),Tower.Store.Memory.include(Tower.Store.Memory.Serialization),Tower.Store.Ajax=function(a){function c(){c.__super__.constructor.apply(this,arguments),this.deleted={}}var b;return __extends(c,a),c.requests=[],c.enabled=!0,c.pending=!1,c.defaults={contentType:"application/json",dataType:"json",processData:!1,headers:{"X-Requested-With":"XMLHttpRequest"}},c.ajax=function(a,b){return $.ajax($.extend({},this.defaults,b,a))},c.toJSON=function(a,b,c){var d;return d={},d[Tower.Support.String.camelize(a.constructor.name,!0)]=a,d.format=b,d._method=c,JSON.stringify(d)},c.disable=function(a){return this.enabled?(this.enabled=!1,a(),this.enabled=!0):a()},c.requestNext=function(){var a;return a=this.requests.shift(),a?this.request(a):this.pending=!1},c.request=function(a){var b=this;return a().complete(function(){return b.requestNext()})},c.queue=function(a){if(!this.enabled)return;return this.pending?this.requests.push(a):(this.pending=!0,this.request(a)),a},c.prototype.success=function(a,b){var d=this;return b==null&&(b={}),function(e,f,g){var h;return c.disable(function(){if(e&&!Tower.Support.Object.isBlank(e))return a.updateAttributes(e,{sync:!1})}),(h=b.success)!=null?h.apply(d.record):void 0}},c.prototype.failure=function(a,b){var c=this;return b==null&&(b={}),function(c,d,e){var f;return(f=b.error)!=null?f.apply(a):void 0}},c.prototype.queue=function(a){return this.constructor.queue(a)},c.prototype.request=function(){var a;return(a=this.constructor).request.apply(a,arguments)},c.prototype.ajax=function(){var a;return(a=this.constructor).ajax.apply(a,arguments)},c.prototype.toJSON=function(){var a;return(a=this.constructor).toJSON.apply(a,arguments)},c.prototype.create=function(a,b,d){var e=this;return b.sync!==!1?c.__super__.create.call(this,a,b,function(a,c){return d&&d.call(e,a,c),e.createRequest(c,b)}):c.__super__.create.apply(this,arguments)},c.prototype.update=function(a,b,d,e){var f=this;return d.sync===!0?c.__super__.update.call(this,a,b,d,function(a,b){return e&&e.call(f,a,b),f.updateRequest(b,d)}):c.__super__.update.apply(this,arguments)},c.prototype.destroy=function(a,b,d){var e=this;return b.sync!==!1?c.__super__.destroy.call(this,a,b,function(a,c){return e.destroyRequest(c,b)}):c.__super__.destroy.apply(this,arguments)},c.prototype.createRequest=function(a,b){var c,d=this;return b==null&&(b={}),c=this.toJSON(a),Tower.urlFor(a.constructor),this.queue(function(){var e;return e={url:url,type:"POST",data:c},d.ajax(b,e).success(d.createSuccess(a)).error(d.createFailure(a))})},c.prototype.createSuccess=function(a){var b=this;return function(c,d,e){var f;return f=a.id,a=b.find(f),b.records[c.id]=a,delete b.records[f],a.updateAttributes(c)}},c.prototype.createFailure=function(a){return this.failure(a)},c.prototype.updateRequest=function(a,b,c){var d=this;return this.queue(function(){var b;return b={type:"PUT",data:d.toJSON(a)},d.ajax({},b).success(d.updateSuccess(a)).error(d.updateFailure(a))})},c.prototype.updateSuccess=function(a){var b=this;return function(c,d,e){return a=Tower.constant(b.className).find(a.id),a.updateAttributes(c)}},c.prototype.updateFailure=function(a){var b=this;return function(a,b,c){}},c.prototype.destroyRequest=function(a,b,c){var d=this;return this.queue(function(){var b;return b={type:"DELETE",data:d.toJSON(a)},d.ajax({},b).success(d.destroySuccess(a)).error(d.destroyFailure(a))})},c.prototype.destroySuccess=function(a){var b=this;return function(a,c,d){return delete b.deleted[a.id]}},c.prototype.destroyFailure=function(a){var b=this;return function(a,b,c){}},c.prototype.findRequest=function(a){var b=this;return this.queue(function(){var c;return c={type:"GET",data:b.toJSON(record)},b.ajax({},c).success(b.findSuccess(a)).error(b.findFailure(a))})},c.prototype.findSuccess=function(a){var b=this;return function(a,c,d){if(Tower.Support.Object.isPresent(a))return b.load(a)}},c.prototype.findFailure=function(a){var b=this;return function(a,b,c){}},c.prototype.findOneRequest=function(a,b){var c=this;return this.queue(function(){var b;return b={type:"GET",data:c.toJSON(record)},c.ajax({},b).success(c.findSuccess(a)).error(c.findFailure(a))})},c.prototype.findOneSuccess=function(a){var b=this;return function(a,b,c){}},c.prototype.findOneFailure=function(a){var b=this;return function(a,b,c){}},b=function(){var a=this;return this.all(function(b,c){var d,e,f,g;d={create:[],update:[],destroy:[]};for(f=0,g=c.length;f<g;f++)e=c[f],e.syncAction&&d[e.syncAction].push(e);return d.create!=null&&a.createRequest(d.create),d.update!=null&&a.updateRequest(d.update),d.destroy!=null&&a.destroyRequest(d.destroy),!0})},c.prototype.refresh=function(){},c.prototype.fetch=function(){},c}(Tower.Store.Memory),Tower.Store.Local=function(a){function b(){b.__super__.constructor.apply(this,arguments)}return __extends(b,a),b.prototype.initialize=function(){return this.lastId=0},b.prototype._setRecord=function(a){},b.prototype._getRecord=function(a){return this},b.prototype._removeRecord=function(a){return delete this.records[record.id]},b}(Tower.Store.Memory),Tower.Model=function(a){function b(a,b){this.initialize(a,b)}return __extends(b,a),b.configure=function(a){return this.config||(this.config={}),typeof a=="function"&&(a=a.call(this)),_.extend(this.config,a),this},b.defaults=function(a){var b,c;for(b in a)c=a[b],this["default"](b,c);return this._defaults},b["default"]=function(a,b){return this._defaults||(this._defaults={}),this._defaults[a]=b},b.prototype.initialize=function(a,b){var c,d,e,f,g,h,i;a==null&&(a={}),b==null&&(b={}),e=this.constructor.fields(),c={};for(g in e)d=e[g],a.hasOwnProperty(g)||(c[g]=d.defaultValue(this));this.attributes=c,this.changes={},this.errors={},this.readOnly=b.hasOwnProperty("readOnly")?b.readOnly:!1,this.persistent=b.hasOwnProperty("persistent")?b.persisted:!1,i=[];for(f in a)h=a[f],i.push(this.attributes[f]=h);return i},b}(Tower.Class),Tower.Model.Scope=function(a){function b(a){a==null&&(a={}),this.model=a.model,this.criteria=a.criteria||new Tower.Model.Criteria,this.store=this.model.store()}return __extends(b,a),b.prototype.toQuery=function(a){return this.toCriteria(a).toQuery()},b.prototype.toCriteria=function(a){var b,c;b=this.criteria.clone();if(a||!b._order.length>0)c=this.model.defaultSort(),c&&b[a||c.direction](c.name);return b},b.prototype.toCreate=function(){return this.toQuery()},b.prototype.toUpdate=function(){return this.toQuery()},b.prototype.toDestroy=function(){},b.prototype.merge=function(a){return this.criteria.merge(a.criteria)},b.prototype.clone=function(){return new this.constructor({model:this.model,criteria:this.criteria.clone()})},b.prototype._extractArgs=function(a,b){var c,d,e,f,g,h;return b==null&&(b={}),a=Tower.Support.Array.args(a),c=Tower.Support.Array.extractBlock(a),g=a[a.length-1],b.data&&(Tower.Support.Object.isHash(g)||Tower.Support.Object.isArray(g))&&(e=a.pop()),Tower.Support.Object.isHash(a[a.length-1])&&(e?(h=e,e=a.pop()):Tower.Support.Object.isBaseObject(a[a.length-1])&&(h=a.pop())),b.data||(e={}),e||(e={}),d=this.criteria.clone(),h||(h={}),h.hasOwnProperty("instantiate")||(h.instantiate=!0),b.ids&&a.length>0&&(f=_.flatten(a)),f&&f.length>0&&(f=_.map(f,function(a){return a instanceof Tower.Model?a.get("id"):a}),d.where({id:{$in:f}})),{criteria:d,data:e,callback:c,options:h}},b}(Tower.Class),Tower.Model.Scope.Finders={ClassMethods:{finderMethods:["find","all","first","last","count","exists"]},find:function(){var a,b,c,d,e,f;return e=this._extractArgs(arguments,{ids:!0}),c=e.criteria,d=e.options,a=e.callback,f=c.toQuery(),b=f.conditions,d=f.options,this._find(b,d,a)},first:function(a){var b,c,d;return d=this.toQuery("asc"),b=d.conditions,c=d.options,this.store.findOne(b,c,a)},last:function(a){var b,c,d;return d=this.toQuery("desc"),b=d.conditions,c=d.options,this.store.findOne(b,c,a)},all:function(a){var b,c,d;return d=this.toQuery(),b=d.conditions,c=d.options,this.store.find(b,c,a)},count:function(a){var b,c,d;return d=this.toQuery(),b=d.conditions,c=d.options,this.store.count(b,c,a)},exists:function(a){var b,c,d;return d=this.toQuery(),b=d.conditions,c=d.options,this.store.exists(b,c,a)},batch:function(){},fetch:function(){},_find:function(a,b,c){return a.id&&a.id.hasOwnProperty("$in")&&a.id.$in.length===1?this.store.findOne(a,b,c):a.id&&!a.id.hasOwnProperty("$in")?(a.id={$in:Tower.Support.Object.toArray(a.id)},this.store.findOne(a,b,c)):this.store.find(a,b,c)}},Tower.Model.Scope.Persistence={ClassMethods:{persistenceMethods:["create","update","destroy"]},build:function(a,b){var c,d;return d=this.toCreate(),c=d.conditions,b=d.options,this._build(a,c,b)},create:function(){var a,b,c,d,e;return e=this._extractArgs(arguments,{data:!0}),b=e.criteria,c=e.data,d=e.options,a=e.callback,b.mergeOptions(d),this._create(b,c,d,a)},update:function(){var a,b,c,d,e;return e=this._extractArgs(arguments,{ids:!0,data:!0}),b=e.criteria,c=e.data,d=e.options,a=e.callback,b.mergeOptions(d),this._update(b,c,d,a)},destroy:function(){var a,b,c,d;return d=this._extractArgs(arguments,{ids:!0}),b=d.criteria,c=d.options,a=d.callback,b.mergeOptions(c),this._destroy(b,c,a)},sync:function(){},transaction:function(){},_build:function(a,b,c){var d,e,f,g;if(Tower.Support.Object.isArray(a)){e=[];for(f=0,g=a.length;f<g;f++)d=a[f],e.push(this.store.serializeModel(Tower.Support.Object.extend({},b,d)));return e}return this.store.serializeModel(Tower.Support.Object.extend({},b,a))},_create:function(a,b,c,d){var e,f,g,h=this;return c.instantiate?(e=Tower.Support.Object.isArray(b),g=Tower.Support.Object.toArray(this.build(b)),f=function(a,b){return a?a.save(b):b()},Tower.async(g,f,function(a){if(!!d)return a?d(a):e?d(a,g):d(a,g[0]);if(a)throw a})):this.store.create(b,c,d)},_update:function(a,b,c,d){var e,f,g,h;return h=a.toQuery(),e=h.conditions,g=h.options,c.instantiate?(f=function(a,c){return a.updateAttributes(b,c)},this._each(e,g,f,d)):this.store.update(b,e,g,d)},_destroy:function(a,b,c){var d,e,f,g;return g=a.toQuery(),d=g.conditions,f=g.options,b.instantiate?(e=function(a,b){return a.destroy(b)},this._each(d,f,e,c)):this.store.destroy(d,f,c)},_each:function(a,b,c,d){var e=this;return this.store.find(a,b,function(a,b){return a?d.call(e,a,b):Tower.async(b,c,function(a){if(!d){if(a)throw a}else if(d)return d.call(e,a,b)})})}},Tower.Model.Scope.Queries={ClassMethods:{queryMethods:["where","order","asc","desc","limit","offset","select","joins","includes","excludes","paginate","within","allIn","allOf","alsoIn","anyIn","anyOf","near","notIn"],queryOperators:{">=":"$gte",$gte:"$gte",">":"$gt",$gt:"$gt","<=":"$lte",$lte:"$lte","<":"$lt",$lt:"$lt",$in:"$in",$nin:"$nin",$any:"$any",$all:"$all","=~":"$regex",$m:"$regex",$regex:"$regex",$match:"$match",$notMatch:"$notMatch","!~":"$nm",$nm:"$nm","=":"$eq",$eq:"$eq","!=":"$neq",$neq:"$neq",$null:"$null",$notNull:"$notNull"}}},Tower.Model.Scope.include(Tower.Model.Scope.Finders),Tower.Model.Scope.include(Tower.Model.Scope.Persistence),Tower.Model.Scope.include(Tower.Model.Scope.Queries),_ref=Tower.Model.Scope.queryMethods,_fn=function(a){return Tower.Model.Scope.prototype[a]=function(){var b,c;return b=this.clone(),(c=b.criteria)[a].apply(c,arguments),b}};for(_i=0,_len=_ref.length;_i<_len;_i++)key=_ref[_i],_fn(key);Tower.Model.Criteria=function(){function a(a){var b,c;a==null&&(a={});for(b in a)c=a[b],this[b]=c;this._where||(this._where=[]),this._order||(this._order=[])}return a.prototype.where=function(a){return a instanceof Tower.Model.Criteria?this.merge(a):this._where.push(a)},a.prototype.order=function(a,b){return b==null&&(b="asc"),this._order||(this._order=[]),this._order.push([a,b])},a.prototype.asc=function(){var a,b,c,d,e;b=1<=arguments.length?__slice.call(arguments,0):[],e=[];for(c=0,d=b.length;c<d;c++)a=b[c],e.push(this.order(a));return e},a.prototype.desc=function(){var a,b,c,d,e;b=1<=arguments.length?__slice.call(arguments,0):[],e=[];for(c=0,d=b.length;c<d;c++)a=b[c],e.push(this.order(a,"desc"));return e},a.prototype.allIn=function(a){return this._whereOperator("$all",a)},a.prototype.anyIn=function(a){return this._whereOperator("$any",a)},a.prototype.notIn=function(a){return this._whereOperator("$nin",a)},a.prototype.offset=function(a){return this._offset=a},a.prototype.limit=function(a){return this._limit=a,this.mergeOptions({limit:a})},a.prototype.select=function(){return this._fields=Tower.Support.Array.args(arguments)},a.prototype.includes=function(){return this._includes=Tower.Support.Array.args(arguments)},a.prototype.page=function(a){return this.offset(a)},a.prototype.paginate=function(a){var b,c;return b=a.perPage||a.limit,c=a.page||1,this.limit(b),this.offset((c-1)*b)},a.prototype.clone=function(){return new this.constructor(this.attributes())},a.prototype.merge=function(a){var b;return b=a.attributes(),b._where.length>0&&(this._where=this._where.concat(b._where)),b._order.length>0&&(this._order=this._order.concat(b._order)),b._offset!=null&&(this._offset=b._offset),b._limit!=null&&(this._limit=b._limit),b._fields&&(this._fields=b._fields),b._offset!=null&&(this._offset=b._offset),this},a.prototype.options=function(){var a;return a={},this._offset!=null&&(a.offset=this._offset),this._limit!=null&&(a.limit=this._limit),this._fields&&(a.fields=this._fields),this._order.length>0&&(a.sort=this._order),a},a.prototype.conditions=function(){var a,b,c,d,e;b={},e=this._where;for(c=0,d=e.length;c<d;c++)a=e[c],Tower.Support.Object.deepMergeWithArrays(b,a);return b},a.prototype.attributes=function(a){return a==null&&(a={}),a._where=this._where.concat(),a._order=this._order.concat(),this._offset!=null&&(a._offset=this._offset),this._limit!=null&&(a._limit=this._limit),this._fields&&(a._fields=this._fields),this._includes&&(a._includes=this._includes),a},a.prototype.toQuery=function(){return{conditions:this.conditions(),options:this.options()}},a.prototype.toUpdate=function(){return this.toQuery()},a.prototype.toCreate=function(){var a,b,c,d,e,f,g,h,i,j;a={},d={},i=this._where;for(f=0,h=i.length;f<h;f++){b=i[f];for(c in b){e=b[c];if(Tower.Store.isKeyword(c))for(g in e)j=e[g],a[g]=j;else if(Tower.Support.Object.isHash(e)&&Tower.Store.hasKeyword(e))for(g in e)j=e[g],a[c]=j;else a[c]=e}}for(c in a)e=a[c],e===void 0&&delete a[c];return{attributes:a,options:d}},a.prototype.mergeOptions=function(a){return a},a.prototype._whereOperator=function(a,b){var c,d,e;d={};for(c in b)e=b[c],d[c]={},d[c][a]=e;return this.where(d)},a}(),Tower.Model.Dirty={isDirty:function(){return Tower.Support.Object.isPresent(this.changes)},attributeChanged:function(a){var b;return b=this.changes[a],b?b[0]!==b[1]:!1},attributeChange:function(a){var b;b=this.changes[a];if(!b)return;return b[1]},attributeWas:function(a){var b;b=this.changes[a];if(!b)return;return b[0]},resetAttribute:function(a){var b;return b=this.changes[a],b&&this.set(a,b[0]),this},toUpdates:function(){var a,b,c,d,e;d={},b=this.attributes,e=this.changes;for(c in e)a=e[c],d[c]=b[c];return d.updatedAt||(d.updatedAt=new Date),d},_attributeChange:function(a,b){var c,d,e;return c=(e=this.changes)[a]||(e[a]=[]),d=c[0]||(c[0]=this.attributes[a]),c[1]=b,c[0]===c[1]&&(c=null),c?this.changes[a]=c:delete this.changes[a],d}},Tower.Model.Conversion={ClassMethods:{baseClass:function(){return this.__super__&&this.__super__.constructor.baseClass&&this.__super__.constructor!==Tower.Model?this.__super__.constructor.baseClass():this},toParam:function(){if(this===Tower.Model)return;return this.metadata().paramNamePlural},toKey:function(){return this.metadata().paramName},url:function(a){var b;return this._url=function(){switch(typeof a){case"object":if(a.parent)return b="/"+Tower.Support.String.parameterize(Tower.Support.String.pluralize(a.parent))+"/:"+Tower.Support.String.camelize(a.parent,!0)+"/"+this.toParam();break;default:return a}}.call(this)},collectionName:function(){return Tower.Support.String.camelize(Tower.Support.String.pluralize(this.name),!0)},resourceName:function(){return Tower.Support.String.camelize(this.name,!0)},metadata:function(){var a,b,c,d,e,f,g,h,i,j;return a=this.name,d=this.metadata[a],d?d:(h=Tower.namespace(),f=Tower.Support.String.camelize(a,!0),g=Tower.Support.String.pluralize(f),b=Tower.Support.String.pluralize(a),i=Tower.Support.String.parameterize(f),j=Tower.Support.String.parameterize(g),e=""+h+"."+a,c=""+h+"."+b+"Controller",this.metadata[a]={name:f,namePlural:g,className:a,classNamePlural:b,paramName:i,paramNamePlural:j,modelName:e,controllerName:c})}},toLabel:function(){return this.className()},toPath:function(){var a,b;return b=this.constructor.toParam(),b===void 0?"/":(a=this.toParam(),a&&(b+="/"+a),b)},toParam:function(){var a;return a=this.get("id"),a!=null?String(a):null},toKey:function(){return this.constructor.tokey()},toCacheKey:function(){},toModel:function(){return this},metadata:function(){return this.constructor.metadata()}},Tower.Model.Inheritance={_computeType:function(){}},Tower.Model.Relation=function(a){function b(a,b,c,d){var e,f;c==null&&(c={});for(e in c)f=c[e],this[e]=f;this.owner=a,this.name=b,this.type=Tower.namespaced(c.type||Tower.Support.String.camelize(Tower.Support.String.singularize(b))),this.ownerType=Tower.namespaced(a.name),this.dependent||(this.dependent=!1),this.counterCache||(this.counterCache=!1),this.hasOwnProperty("cache")||(this.cache=!1),this.hasOwnProperty("readOnly")||(this.readOnly=!1),this.hasOwnProperty("validate")||(this.validate=!1),this.hasOwnProperty("autoSave")||(this.autoSave=!1),this.hasOwnProperty("touch")||(this.touch=!1),this.inverseOf||(this.inverseOf=void 0),this.polymorphic=c.hasOwnProperty("as")||!!c.polymorphic,this.hasOwnProperty("default")||(this["default"]=!1),this.singularName=Tower.Support.String.camelize(a.name,!0),this.pluralName=Tower.Support.String.pluralize(a.name),this.singularTargetName=Tower.Support.String.singularize(b),this.pluralTargetName=Tower.Support.String.pluralize(b),this.targetType=this.type,this.foreignKey||(this.as?this.foreignKey=""+this.as+"Id":this.foreignKey=""+this.singularName+"Id"),this.polymorphic&&(this.foreignType||(this.foreignType=""+this.as+"Type")),this.cache&&(typeof this.cache=="string"?(this.cacheKey=this.cache,this.cache=!0):this.cacheKey=this.singularTargetName+"Ids",this.owner.field(this.cacheKey,{type:"Array","default":[]})),this.counterCache&&(typeof this.counterCache=="string"?(this.counterCacheKey=this.counterCache,this.counterCache=!0):this.counterCacheKey=""+this.singularTargetName+"Count",this.owner.field(this.counterCacheKey,{type:"Integer","default":0})),this.owner.prototype[b]=function(){return this.relation(b)}}return __extends(b,a),b.prototype.scoped=function(a){return new this.constructor.Scope({model:this.klass(),owner:a,relation:this})},b.prototype.targetKlass=function(){return Tower.constant(this.targetType)},b.prototype.klass=function(){return Tower.constant(this.type)},b.prototype.inverse=function(){var a,b,c;if(this._inverse)return this._inverse;c=this.targetKlass().relations();for(a in c){b=c[a];if(b.inverseOf===this.name)return b;if(b.targetType===this.ownerType)return b}return null},b.Scope=function(a){function b(a){a==null&&(a={}),b.__super__.constructor.call(this,a),this.owner=a.owner,this.relation=a.relation}return __extends(b,a),b.prototype.isConstructable=function(){return!this.relation.polymorphic},b.prototype.clone=function(){return new this.constructor({model:this.model,criteria:this.criteria.clone(),owner:this.owner,relation:this.relation})},b.prototype.setInverseInstance=function(a){var b;if(a&&this.invertibleFor(a))return b=a.relation(this.inverseReflectionFor(a).name),b.target=owner},b.prototype.invertibleFor=function(a){return!0},b.prototype.inverse=function(a){},b}(Tower.Model.Scope),b}(Tower.Class),Tower.Model.Relation.BelongsTo=function(a){function b(a,c,d){var e;d==null&&(d={}),b.__super__.constructor.call(this,a,c,d),this.foreignKey=""+c+"Id",a.field(this.foreignKey,{type:"Id"}),this.polymorphic&&(this.foreignType=""+c+"Type",a.field(this.foreignType,{type:"String"})),a.prototype[c]=function(a){return this.relation(c).first(a)},e=this,a.prototype["build"+Tower.Support.String.camelize(c)]=function(a,b){return this.buildRelation(c,a,b)},a.prototype["create"+Tower.Support.String.camelize(c)]=function(a,b){return this.createRelation(c,a,b)}}return __extends(b,a),b.Scope=function(a){function b(){b.__super__.constructor.apply(this,arguments)}return __extends(b,a),b}(b.Scope),b}(Tower.Model.Relation),Tower.Model.Relation.HasMany=function(a){function b(){b.__super__.constructor.apply(this,arguments)}return __extends(b,a),b.Scope=function(a){function b(){b.__super__.constructor.apply(this,arguments)}return __extends(b,a),b.prototype.create=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o=this;if(!this.owner.isPersisted())throw new Error("You cannot call create unless the parent is saved");return k=this.relation,i=k.inverse(),m=this._extractArgs(arguments,{data:!0}),d=m.criteria,e=m.data,j=m.options,c=m.callback,g=this.owner.get("id"),i&&i.cache?(a=e[i.cacheKey]||[],a.indexOf(g)===-1&&a.push(g),e[i.cacheKey]=a):k.foreignKey&&(g!==void 0&&(e[k.foreignKey]=g),this.relation.foreignType&&(e[l=k.foreignType]||(e[l]=this.owner.constructor.name))),d.where(e),d.mergeOptions(j),i&&i.counterCacheKey&&(f={},f[i.counterCacheKey]=1,d.where(f)),h=j.instantiate!==!1,n=d.toCreate(),b=n.attributes,j=n.options,j.instantiate=!0,this._create(d,b,j,function(a,b){var d,e,f;if(!a){if(k&&(k.cache||k.counterCache))return k.cache&&(e={},e[k.cacheKey]=b.get("id")),k.counterCacheKey&&(d={},d[k.counterCacheKey]=1),f={},e&&(f.$push=e),d&&(f.$inc=d),o.owner.updateAttributes(f,c);if(c)return c.call(o,a,b)}else if(c)return c.call(o,a,b)})},b.prototype.update=function(){},b.prototype.destroy=function(){},b.prototype.concat=function(){},b.prototype._serializeAttributes=function(a){var b,c,d,e,f;a==null&&(a={}),d=Tower.constant(this.relation.targetClassName),f=d.relations();for(b in f)c=f[b],a.hasOwnProperty(b)&&(e=a[b],delete a[b],c instanceof Tower.Model.Relation.BelongsTo&&(a[c.foreignKey]=e.id,c.polymorphic&&(a[c.foreignType]=e.type)));return a},b.prototype.toCriteria=function(){var a,c,d;return a=b.__super__.toCriteria.apply(this,arguments),d=this.relation,d.cache&&(c={},c[d.foreignKey+"s"]={$in:[this.owner.get("id")]},a.where(c)),a},b}(b.Scope),b}(Tower.Model.Relation),Tower.Model.Relation.HasOne=function(a){function b(){b.__super__.constructor.apply(this,arguments)}return __extends(b,a),b}(Tower.Model.Relation),Tower.Model.Relations={ClassMethods:{hasOne:function(a,b){return b==null&&(b={}),this.relations()[a]=new Tower.Model.Relation.HasOne(this,a,b)},hasMany:function(a,b){return b==null&&(b={}),this.relations()[a]=new Tower.Model.Relation.HasMany(this,a,b)},belongsTo:function(a,b){return this.relations()[a]=new Tower.Model.Relation.BelongsTo(this,a,b)},relations:function(){return this._relations||(this._relations={})},relation:function(a){var b;b=this.relations()[a];if(!b)throw new Error("Relation '"+a+"' does not exist on '"+this.name+"'");return b}},relation:function(a){return this.constructor.relation(a).scoped(this)},buildRelation:function(a,b,c){return this.relation(a).build(b,c)},createRelation:function(a,b,c){return this.relation(a).create(b,c)},destroyRelations:function(){}},Tower.Model.Attribute=function(){function a(a,b,c){c==null&&(c={}),this.owner=a,this.name=key=b,this.type=c.type||"String",typeof this.type!="string"&&(this.type="Array"),this._default=c["default"],this._encode=c.encode,this._decode=c.decode,Tower.accessors&&Object.defineProperty(this.owner.prototype,b,{enumerable:!0,configurable:!0,get:function(){return this.get(key)},set:function(a){return this.set(key,a)}})}return a.prototype.defaultValue=function(a){var b;return b=this._default,Tower.Support.Object.isArray(b)?b.concat():Tower.Support.Object.isHash(b)?Tower.Support.Object.extend({},b):typeof b=="function"?b.call(a):b},a.prototype.encode=function(a,b){return this.code(this._encode,a,b)},a.prototype.decode=function(a,b){return this.code(this._decode,a,b)},a.prototype.code=function(a,b,c){switch(a){case"string":return c[a].call(c[a],b);case"function":return a.call(_encode,b);default:return b}},a}(),Tower.Model.Attributes={ClassMethods:{field:function(a,b){return this.fields()[a]=new Tower.Model.Attribute(this,a,b)},fields:function(){return this._fields||(this._fields={})}},get:function(a){var b;return this.has(a)||(b=this.constructor.fields()[a],b&&(this.attributes[a]=b.defaultValue(this))),this.attributes[a]},set:function(a,b){var c,d;typeof a=="object"?c=a:(c={},c[a]=b),d=[];for(a in c)b=c[a],d.push(this._set(a,b));return d},_set:function(a,b){return this._attributeChange(a,b),this.attributes[a]=b},assignAttributes:function(a){var b,c;for(b in a)c=a[b],delete this.changes[b],this.attributes[b]=c;return this},has:function(a){return this.attributes.hasOwnProperty(a)}},Tower.Model.Persistence={ClassMethods:{defaultStore:Tower.client?Tower.Store.Memory:Tower.Store.MongoDB,store:function(a){return!a&&this._store?this._store:(typeof a=="function"?this._store=new a({name:this.collectionName(),type:Tower.namespaced(this.name)}):typeof a=="object"?(this._store||(this._store=new this.defaultStore({name:this.collectionName(),type:Tower.namespaced(this.name)})),Tower.Support.Object.extend(this._store,a)):a&&(this._store=a),this._store||(this._store=new this.defaultStore({name:this.collectionName(),type:Tower.namespaced(this.name)})),this._store)},load:function(a){return this.store().load(a)}},InstanceMethods:{save:function(a,b){var c=this;if(this.readOnly)throw new Error("Record is read only");return typeof a=="function"&&(b=a,a={}),a||(a={}),a.validate!==!1?this.validate(function(a){if(!a)return c._save(b);if(b)return b.call(c,null,!1)}):this._save(b),this},updateAttributes:function(a,b){return this.set(a),this._update(a,b)},destroy:function(a){return this.isNew()?a&&a.call(this,null):this._destroy(a),this},"delete":function(a){return this.destroy(a)},isPersisted:function(){return!!this.persistent},isNew:function(){return!this.isPersisted()},reload:function(){},store:function(){return this.constructor.store()},_save:function(a){var b=this;return this.runCallbacks("save",function(c){var d;return d=b._callback(c,a),b.isNew()?b._create(d):b._update(b.toUpdates(),d)})},_create:function(a){var b=this;return this.runCallbacks("create",function(c){var d;return d=b._callback(c,a),b.constructor.create(b,{instantiate:!1},function(c){if(c&&!a)throw c;return c||(b.changes={},b.persistent=!0),d.call(b,c)})}),this},_update:function(a,b){var c=this;return this.runCallbacks("update",function(d){var e;return e=c._callback(d,b),c.constructor.update(c.get("id"),a,{instantiate:!1},function(a){if(a&&!b)throw a;return a||(c.changes={},c.persistent=!0),e.call(c,a)})}),this},_destroy:function(a){var b=this;return this.runCallbacks("destroy",function(c){var d;return d=b._callback(c,a),b.constructor.destroy(b,{instantiate:!1},function(c){if(c&&!a)throw c;return c||(b.persistent=!1,b.changes={},delete b.attributes.id),d.call(b,c)})}),this}}},Tower.Model.Scopes={ClassMethods:{scope:function(a,b){return this[a]=b instanceof Tower.Model.Scope?b:this.where(b)},scoped:function(){var a;return a=new Tower.Model.Scope({model:this}),this.baseClass().name!==this.name&&a.where({type:this.name}),a},defaultSort:function(a){return a&&(this._defaultSort=a),this._defaultSort||(this._defaultSort={name:"createdAt",direction:"desc"})}}},_ref2=Tower.Model.Scope.queryMethods,_fn2=function(a){return Tower.Model.Scopes.ClassMethods[a]=function(){var b;return(b=this.scoped())[a].apply(b,arguments)}};for(_j=0,_len2=_ref2.length;_j<_len2;_j++)key=_ref2[_j],_fn2(key);_ref3=Tower.Model.Scope.finderMethods,_fn3=function(a){return Tower.Model.Scopes.ClassMethods[a]=function(){var b;return(b=this.scoped())[a].apply(b,arguments)}};for(_k=0,_len3=_ref3.length;_k<_len3;_k++)key=_ref3[_k],_fn3(key);_ref4=Tower.Model.Scope.persistenceMethods,_fn4=function(a){return Tower.Model.Scopes.ClassMethods[a]=function(){var b;return(b=this.scoped())[a].apply(b,arguments)}};for(_l=0,_len4=_ref4.length;_l<_len4;_l++)key=_ref4[_l],_fn4(key);Tower.Model.Serialization={ClassMethods:{fromJSON:function(a){var b,c,d,e;d=JSON.parse(a),d instanceof Array||(d=[d]);for(b=0,e=d.length;b<e;b++)c=d[b],d[b]=new this(c);return d},toJSON:function(a,b){var c,d,e,f;b==null&&(b={}),d=[];for(f=0,e=a.length;f<e;f++)c=a[f],d.push(c.toJSON());return d}},toJSON:function(a){return this._serializableHash(a)},clone:function(){return new this.constructor(Tower.Support.Object.clone(this.attributes))},_serializableHash:function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v;a==null&&(a={}),n={},b=Tower.Support.Object.keys(this.attributes);if(j=a.only)b=_.union(Tower.Support.Object.toArray(j),b);else if(c=a.except)b=_.difference(Tower.Support.Object.toArray(c),b);for(t=0,p=b.length;t<p;t++)i=b[t],n[i]=this._readAttributeForSerialization(i);if(h=a.methods){g=Tower.Support.Object.toArray(h);for(u=0,q=h.length;u<q;u++)i=h[u],n[i]=this[i]()}if(f=a.include){f=Tower.Support.Object.toArray(f);for(v=0,r=f.length;v<r;v++){e=f[v],Tower.Support.Object.isHash(e)||(o={},o[e]={},e=o,o=void 0);for(i in e){k=e[i],m=this[i]().all();for(d=0,s=m.length;d<s;d++)l=m[d],m[d]=l._serializableHash(k);n[i]=m}}}return n},_readAttributeForSerialization:function(a,b){return b==null&&(b="json"),this.attributes[a]}},Tower.Model.Validator=function(){function a(a,b,c){this.name=a,this.value=b,this.attributes=c}return a.create=function(a,b,c){switch(a){case"presence":return new this.Presence(a,b,c);case"count":case"length":case"min":case"max":return new this.Length(a,b,c);case"format":return new this.Format(a,b,c)}},a.prototype.validateEach=function(a,b,c){var d,e=this;return d=function(c,d){return e.validate(a,c,b,function(a){return d()})},Tower.async(this.attributes,d,function(a){if(c)return c.call(e,a)})},a.prototype.success=function(a){return a&&a.call(this),!0},a.prototype.failure=function(a,b,c,d,e){return c[b]||(c[b]=[]),c[b].push(d),e&&e.call(this,d),!1},a}(),Tower.Model.Validator.Format=function(){function a(b,c){a.__super__.constructor.call(this,b,c),this.value=typeof b=="string"?new RegExp(b):b}return a.prototype.validate=function(a,b,c,d){var e;return e=a.get(b),this.value.exec(e)?this.success(d):this.failure(a,b,c,Tower.t("model.errors.format",{attribute:b,value:this.value.toString()}),d)},a}(),Tower.Model.Validator.Length=function(a){function b(a,c,d){b.__super__.constructor.apply(this,arguments),this.validate=function(){switch(a){case"min":return this.validateMinimum;case"max":return this.validateMaximum;default:return this.validateLength}}.call(this)}return __extends(b,a),b.prototype.validateMinimum=function(a,b,c,d){var e;return e=a.get(b),typeof e=="number"&&e>=this.value?this.success(d):this.failure(a,b,c,Tower.t("model.errors.minimum",{attribute:b,value:this.value}),d)},b.prototype.validateMaximum=function(a,b,c,d){var e;return e=a.get(b),typeof e=="number"&&e<=this.value?this.success(d):this.failure(a,b,c,Tower.t("model.errors.maximum",{attribute:b,value:this.value}),d)},b.prototype.validateLength=function(a,b,c,d){var e;return e=a.get(b),typeof e!="number"||e!==this.value?this.failure(a,b,c,Tower.t("model.errors.length",{attribute:b,value:this.value}),d):this.success(d)},b}(Tower.Model.Validator),Tower.Model.Validator.Presence=function(a){function b(){b.__super__.constructor.apply(this,arguments)}return __extends(b,a),b.prototype.validate=function(a,b,c,d){return Tower.Support.Object.isPresent(a.get(b))?this.success(d):this.failure(a,b,c,Tower.t("model.errors.presence",{attribute:b}),d)},b}(Tower.Model.Validator),Tower.Model.Validator.Uniqueness=function(a){function b(){b.__super__.constructor.apply(this,arguments)}return __extends(b,a),b.prototype.validate=function(a,b,c,d){var e,f,g=this;return f=a.get(b),e={},e[b]=f,a.constructor.where(e).exists(function(e,h){return h?g.failure(a,b,c,Tower.t("model.errors.uniqueness",{attribute:b,value:f}),d):g.success(d)})},b}(Tower.Model.Validator),Tower.Model.Validations={ClassMethods:{validates:function(){var a,b,c,d,e,f;a=Tower.Support.Array.args(arguments),c=a.pop(),d=this.validators(),f=[];for(b in c)e=c[b],f.push(d.push(Tower.Model.Validator.create(b,e,a)));return f},validators:function(){return this._validators||(this._validators=[])}},validate:function(a){var b,c=this;return b=!1,this.runCallbacks("validate",function(d){var e,f,g,h;return e=c._callback(d,a),h=c.constructor.validators(),f=c.errors={},g=function(a,b){return a.validateEach(c,f,b)},Tower.async(h,g,function(a){return!a&&!Tower.Support.Object.isPresent(f)&&(b=!0),e.call(c,!b)}),b}),b}},Tower.Model.Timestamp={ClassMethods:{timestamps:function(){return this.include(Tower.Model.Timestamp.CreatedAt),this.include(Tower.Model.Timestamp.UpdatedAt),this.field("createdAt",{type:"Date"}),this.field("updatedAt",{type:"Date"}),this.before("create","setCreatedAt"),this.before("save","setUpdatedAt")}},CreatedAt:{ClassMethods:{},setCreatedAt:function(){return this.set("createdAt",new Date)}},UpdatedAt:{ClassMethods:{},setUpdatedAt:function(){return this.set("updatedAt",new Date)}}},Tower.Support.I18n.load({model:{errors:{presence:"%{attribute} can't be blank",minimum:"%{attribute} must be a minimum of %{value}",maximum:"%{attribute} must be a maximum of %{value}",length:"%{attribute} must be equal to %{value}",format:"%{attribute} must be match the format %{value}",inclusion:"%{attribute} is not included in the list",exclusion:"%{attribute} is reserved",invalid:"%{attribute} is invalid",confirmation:"%{attribute} doesn't match confirmation",accepted:"%{attribute} must be accepted",empty:"%{attribute} can't be empty",blank:"%{attribute} can't be blank",tooLong:"%{attribute} is too long (maximum is %{count} characters)",tooShort:"%{attribute} is too short (minimum is %{count} characters)",wrongLength:"%{attribute} is the wrong length (should be %{count} characters)",taken:"%{attribute} has already been taken",notANumber:"%{attribute} is not a number",greaterThan:"%{attribute} must be greater than %{count}",greaterThanOrEqualTo:"%{attribute} must be greater than or equal to %{count}",equalTo:"%{attribute} must be equal to %{count}",lessThan:"%{attribute} must be less than %{count}",lessThanOrEqualTo:"%{attribute} must be less than or equal to %{count}",odd:"%{attribute} must be odd",even:"%{attribute} must be even",recordInvalid:"Validation failed: %{errors}"},fullMessages:{format:"%{message}"}}}),Tower.Model.include(Tower.Support.Callbacks),Tower.Model.include(Tower.Model.Conversion),Tower.Model.include(Tower.Model.Dirty),Tower.Model.include(Tower.Model.Criteria),Tower.Model.include(Tower.Model.Scopes),Tower.Model.include(Tower.Model.Persistence),Tower.Model.include(Tower.Model.Inheritance),Tower.Model.include(Tower.Model.Serialization),Tower.Model.include(Tower.Model.Relations),Tower.Model.include(Tower.Model.Validations),Tower.Model.include(Tower.Model.Attributes),Tower.Model.include(Tower.Model.Timestamp),Tower.View=function(a){function b(a){a==null&&(a={}),this._context=a}return __extends(b,a),b.extend({cache:{},engine:"coffee",prettyPrint:!1,loadPaths:["app/views"],componentSuffix:"widget",hintClass:"hint",hintTag:"figure",labelClass:"label",requiredClass:"required",requiredAbbr:"*",requiredTitle:"Required",errorClass:"error",errorTag:"output",validClass:null,optionalClass:"optional",optionalAbbr:"",optionalTitle:"Optional",labelMethod:"humanize",labelAttribute:"toLabel",validationMaxLimit:255,defaultTextFieldSize:null,defaultTextAreaWidth:300,allFieldsRequiredByDefault:!0,fieldListTag:"ol",fieldListClass:"fields",fieldTag:"li",separator:"-",breadcrumb:" - ",includeBlankForSelectByDefault:!0,collectionLabelMethods:["toLabel","displayName","fullName","name","title","toString"],i18nLookupsByDefault:!0,escapeHtmlEntitiesInHintsAndLabels:!1,renameNestedAttributes:!0,inlineValidations:!0,autoIdForm:!0,fieldsetClass:"fieldset",fieldClass:"field",validateClass:"validate",legendClass:"legend",formClass:"form",idEnabledOn:["input","field"],widgetsPath:"shared/widgets",navClass:"list-item",includeAria:!0,activeClass:"active",navTag:"li",termsTag:"dl",termClass:"term",termKeyClass:"key",termValueClass:"value",hintIsPopup:!1,listTag:"ul",pageHeaderId:"header",pageTitleId:"title",autoIdNav:!1,pageSubtitleId:"subtitle",widgetClass:"widget",headerClass:"header",titleClass:"title",subtitleClass:"subtitle",contentClass:"content",defaultHeaderLevel:3,termSeparator:":",richInput:!1,submitFieldsetClass:"submit-fieldset",addLabel:"+",removeLabel:"-",cycleFields:!1,alwaysIncludeHintTag:!1,alwaysIncludeErrorTag:!0,requireIfValidatesPresence:!0,localizeWithNamespace:!1,localizeWithNestedModel:!1,localizeWithInheritance:!0,defaultComponentHeaderLevel:3,helpers:[],metaTags:["description","keywords","author","copyright","category","robots"],store:function(a){return a&&(this._store=a),this._store||(this._store=new Tower.Store.Memory({name:"view"}))},renderers:{}}),b}(Tower.Class),Tower.View.Helpers={titleTag:function(a){return"<title>"+a+"</title>"},metaTag:function(a,b){return'<meta name="'+a+'" content="'+b+'"/>'},tag:function(a,b){},linkTag:function(a,b,c){},imageTag:function(a,b){},csrfMetaTag:function(){return this.metaTag("csrf-token",this.request.session._csrf)},contentTypeTag:function(a){return a==null&&(a="UTF-8"),'<meta charset="'+a+'" />'},javascriptTag:function(a){return'<script type="text/javascript" src="'+a+'" ></script>'},stylesheetTag:function(a){return'<link href="'+a+'" media="screen" rel="stylesheet" type="text/css"/>'},mobileTags:function(){return"<meta content='yes' name='apple-mobile-web-app-capable'>\n<meta content='yes' name='apple-touch-fullscreen'>\n<meta content='initial-scale = 1.0, maximum-scale = 1.0, user-scalable = no, width = device-width' name='viewport'>"}},Tower.View.Rendering={render:function(a,b){var c=this;return a.type||(a.type=this.constructor.engine),!a.hasOwnProperty("layout")&&this._context.layout&&(a.layout=this._context.layout()),a.locals=this._renderingContext(a),this._renderBody(a,function(d,e){return d?b(d,e):c._renderLayout(e,a,b)})},partial:function(a,b,c){var d,e;return typeof b=="function"&&(c=b,b={}),b||(b={}),d=b.prefixes,this._context&&(d||(d=[this._context.collectionName])),e=this._readTemplate(a,d,b.type||Tower.View.engine),this._renderString(e,b,c)},_renderBody:function(a,b){return a.text?b(null,a.text):a.json?b(null,typeof a.json=="string"?a.json:JSON.stringify(a.json)):(a.inline||(a.template=this._readTemplate(a.template,a.prefixes,a.type)),this._renderString(a.template,a,b))},_renderLayout:function(a,b,c){var d;return b.layout?(d=this._readTemplate("layouts/"+b.layout,[],b.type),b.locals.body=a,this._renderString(d,b,c)):c(null,a)},_renderString:function(a,b,c){var d,e,f,g,h,i,j,k,l,m;b==null&&(b={});if(!b.type.match(/coffee/))return b.type?(f=require("mint").engine(b.type),mint[f](a,b.locals,c)):(f=require("mint"),b.locals.string=a,f.render(b.locals,c));e=null,j=null,d=Tower.client?global.CoffeeKup:require("coffeekup");try{i=b.locals,i.renderWithEngine=this.renderWithEngine,i._readTemplate=this._readTemplate,i.cache=Tower.env!=="development",i.format=!0,g={},m=Tower.View.helpers;for(l=0,k=m.length;l<k;l++)h=m[l],g=_.extend(g,h);g=_.extend(g,{tags:d.tags}),i.hardcode=g,i._=_,j=d.render(a,i)}catch(n){e=n}return c(e,j)},_renderingContext:function(a){var b,c,d;c=this,_ref=this._context;for(b in _ref)d=_ref[b],b.match(/^(constructor|head)/)||(c[b]=d);return c=Tower.Support.Object.extend(c,a.locals),this.constructor.prettyPrint&&(c.pretty=!0),c},_readTemplate:function(a,b,c){var d,e,f;if(typeof a!="string")return a;d=(e=this.constructor.cache)[f="app/views/"+a]||(e[f]=this.constructor.store().find({path:a,ext:c,prefixes:b}));if(!d)throw new Error("Template '"+a+"' was not found.");return d},renderWithEngine:function(a,b){var c;return Tower.client?"("+a+").call(this);":(c=require("mint"),c[c.engine(b||"coffee")](a,{},function(a,b){if(a)return console.log(a)}))}},Tower.View.Component=function(){function a(a,b){var c,d;for(c in b)d=b[c],this[c]=d}return a.render=function(){var a,b,c,d;return a=Tower.Support.Array.args(arguments),d=a.shift(),b=Tower.Support.Array.extractBlock(a),a[a.length-1]instanceof Tower.Model||typeof a[a.length-1]!="object"||(c=a.pop()),c||(c={}),c.template=d,(new this(a,c)).render(b)},a.prototype.tag=function(){var a,b;return b=arguments[0],a=2<=arguments.length?__slice.call(arguments,1):[],this.template.tag(b,a)},a.prototype.addClass=function(a,b){var c,d,e,f;d=a?a.split(/\s+/g):[];for(f=0,e=b.length;f<e;f++){c=b[f];if(!c)continue;d.indexOf(c)>-1||d.push(c)}return d.join(" ")},a}(),Tower.View.Table=function(a){function b(a,c){var d,e,f;b.__super__.constructor.apply(this,arguments),f=a.shift(),this.key=this.recordKey(f),this.rowIndex=0,this.cellIndex=0,this.scope="table",this.headers=[],c.summary||(c.summary="Table for "+_.titleize(this.key)),c.role="grid",c["class"]=this.addClass(c["class"]||"",["table"]),e=c.data||(c.data={}),c.hasOwnProperty("total")&&(e.total=c.total),c.hasOwnProperty("page")&&(e.page=c.page),c.hasOwnProperty("count")&&(e.count=c.count),d=c.aria||{},delete c.aria,!d.hasOwnProperty("aria-multiselectable")&&c.multiselect!==!0&&(d["aria-multiselectable"]=!1),c.id||(c.id=""+f+"-table"),this.options={summary:c.summary,role:c.role,data:c.data,"class":c["class"]}}return __extends(b,a),b.prototype.render=function(a){var b=this;return this.tag("table",this.options,function(){return a&&a(b),null})},b.prototype.tableQueryRowClass=function(){return["search-row",queryParams.except("page","sort").blank!=null?null:"search-results"].compact.join(" ")},b.prototype.linkToSort=function(a,b,c){var d;return c==null&&(c={}),d=sortValue(b,oppositeSortDirection(b)),linkTo(a,withParams(request.path,{sort:d}),c)},b.prototype.nextPagePath=function(a){return withParams(request.path,{page:a.nextPage})},b.prototype.prevPagePath=function(a){return withParams(request.path,{page:a.prevPage})},b.prototype.firstPagePath=function(a){return withParams(request.path,{page:1})},b.prototype.lastPagePath=function(a){return withParams(request.path,{page:a.lastPage})},b.prototype.currentPageNum=function(){var a;return a=params.page?params.page:1,a<1&&(a=1),a},b.prototype.caption=function(){},b.prototype.head=function(a,b){return a==null&&(a={}),this.hideHeader=a.visible===!1,delete a.visible,this._section("head",a,b)},b.prototype.body=function(a,b){return a==null&&(a={}),this._section("body",a,b)},b.prototype.foot=function(a,b){return a==null&&(a={}),this._section("foot",a,b)},b.prototype._section=function(a,b,c){return this.rowIndex=0,this.scope=a,this.tag("t"+a,b,c),this.rowIndex=0,this.scope="table"},b.prototype.row=function(){var a,b,c,d;return a=2<=arguments.length?__slice.call(arguments,0,d=arguments.length-1):(d=0,[]),c=arguments[d++],b=Tower.Support.Array.extractOptions(a),b.scope="row",this.scope==="body"&&(b.role="row"),this.rowIndex+=1,this.cellIndex=0,this.tag("tr",b,c),this.cellIndex=0},b.prototype.column=function(){var a,b,c,d,e,f;a=2<=arguments.length?__slice.call(arguments,0,f=arguments.length-1):(f=0,[]),c=arguments[f++],b=Tower.Support.Array.extractOptions(a),d=a.shift();if(typeof (e=Tower.View.idEnabledOn).include=="function"?e.include("table"):void 0)b.id||(b.id=this.idFor("header",key,d,this.rowIndex,this.cellIndex));return b.hasOwnProperty("width")&&(b.width=this.pixelate(b.width)),b.hasOwnProperty("height")&&(b.height=this.pixelate(b.height)),this.headers.push(b.id),tag("col",b),this.cellIndex+=1},b.prototype.header=function(){var a,b,c,d,e,f,g,h,i=this;a=Tower.Support.Array.args(arguments),c=Tower.Support.Array.extractBlock(a),b=Tower.Support.Array.extractOptions(a),g=a.shift(),b.abbr||(b.abbr=g),b.role="columnheader";if(typeof (h=Tower.View.idEnabledOn).include=="function"?h.include("table"):void 0)b.id||(b.id=this.idFor("header",key,g,this.rowIndex,this.cellIndex));return b.scope="col",b.hasOwnProperty("for")&&(b.abbr||(b.abbr=b["for"])),b.abbr||(b.abbr=g),delete b["for"],b.hasOwnProperty("width")&&(b.width=this.pixelate(b.width)),b.hasOwnProperty("height")&&(b.height=this.pixelate(b.height)),f=b.sort===!0,delete b.sort,f&&(b["class"]=this.addClass(b["class"]||"",[b.sortClass||"sortable"]),b.direction||(b.direction="asc")),delete b.sortClass,e=b.label||_.titleize(g.toString()),delete b.label,d=b.direction,delete b.direction,d?(b["aria-sort"]=d,b["class"]=[b["class"],d].join(" "),b["aria-selected"]=!0):(b["aria-sort"]="none",b["aria-selected"]=!1),this.headers.push(b.id),c?this.tag("th",b,c):f?this.tag("th",b,function(){return i.linkToSort(e,g)}):this.tag("th",b,function(){return i.tag("span",e)}),this.cellIndex+=1},b.prototype.linkToSort=function(a,b){var c,d=this;return c="asc",this.tag("a",{href:"?sort="+c},function(){return d.tag("span",a)})},b.prototype.cell=function(){var a,b,c,d,e,f;a=2<=arguments.length?__slice.call(arguments,0,f=arguments.length-1):(f=0,[]),c=arguments[f++],b=Tower.Support.Array.extractOptions(a),d=a.shift(),b.role="gridcell";if(typeof (e=Tower.View.idEnabledOn).include=="function"?e.include("table"):void 0)b.id||(b.id=this.idFor("cell",key,d,this.rowIndex,this.cellIndex));return b.headers=this.headers[this.cellIndex],b.hasOwnProperty("width")&&(b.width=this.pixelate(b.width)),b.hasOwnProperty("height")&&(b.height=this.pixelate(b.height)),c?this.tag("td",b,c):this.tag("td",d,b),this.cellIndex+=1},b.prototype.recordKey=function(a){return typeof a=="string"?a:a.constructor.name},b.prototype.idFor=function(a,b,c,d,e){return d==null&&(d=this.row_index),e==null&&(e=this.column_index),[b,a,d,e].compact.map(function(a){return a.replace(/[\s_]/,"-")}),end.join("-")},b.prototype.pixelate=function(a){return typeof a=="string"?a:""+a+"px"},b}(Tower.View.Component),Tower.View.Form=function(a){function b(a,c){var d;b.__super__.constructor.apply(this,arguments),this.model=a.shift()||new Tower.Model,typeof this.model=="string"&&(d=Tower.constant(Tower.Support.String.camelize(this.model)),this.model=d?new d:null),this.attributes=this._extractAttributes(c)}return __extends(b,a),b.prototype.render=function(a){var b=this;return this.tag("form",this.attributes,function(){var c;b.tag("input",{type:"hidden",name:"_method",value:b.attributes["data-method"]});if(a)return c=new Tower.View.Form.Builder([],{template:b.template,tabindex:1,accessKeys:{},model:b.model}),c.render(a)})},b.prototype._extractAttributes=function(a){var b,c;a==null&&(a={}),b=a.html||{},b.action=a.url||Tower.urlFor(this.model),a.hasOwnProperty("class")&&(b["class"]=a["class"]),a.hasOwnProperty("id")&&(b.id=a.id),b.id||(b.id=Tower.Support.String.parameterize(""+this.model.constructor.name+"-form"));if(a.multipart||b.multipart===!0)b.enctype="multipart/form-data";b.role="form",b.novalidate="true",a.hasOwnProperty("validate")&&(b["data-validate"]=a.validate.toString()),c=b.method||a.method;if(!c||c==="")this.model&&this.model.get("id")?c="put":c="post";return b["data-method"]=c,b.method=c==="get"?"get":"post",b},b}(Tower.View.Component),Tower.View.Form.Builder=function(a){function b(a,b){b==null&&(b={}),this.template=b.template,this.model=b.model,this.attribute=b.attribute,this.parentIndex=b.parentIndex,this.index=b.index,this.tabindex=b.tabindex,this.accessKeys=b.accessKeys}return __extends(b,a),b.prototype.defaultOptions=function(a){return a==null&&(a={}),a.model||(a.model=this.model),a.index||(a.index=this.index),a.attribute||(a.attribute=this.attribute),a.template||(a.template=this.template),a},b.prototype.fieldset=function(){var a,b,c;return a=1<=arguments.length?__slice.call(arguments,0):[],b=a.pop(),c=this.defaultOptions(Tower.Support.Array.extractOptions(a)),c.label||(c.label=a.shift()),(new Tower.View.Form.Fieldset([],c)).render(b)},b.prototype.fields=function(){var a,b,c,d,e=this;return a=Tower.Support.Array.args(arguments),c=Tower.Support.Array.extractBlock(a),d=Tower.Support.Array.extractOptions(a),d.as="fields",d.label||(d.label=!1),b=a.shift()||this.attribute,this.field(b,d,function(a){return e.fieldset(c)})},b.prototype.fieldsFor=function(){var a,b,c,d,e,f,g,h;f=args.extractOptions,b=args.shift,e=model.macroFor(b),a=nil,f.as==="object"?a=b.toS:a=Tower.View.renameNestedAttributes?""+b+"_attributes":b.toS,h=model.object,g=args.shift,c=f["delete"]("index");if(c.present==null||typeof c!="string")g.blank!=null&&c.present!=null?g=h.send(b)[c]:c.blank!=null&&g.present!=null&&e==="hasMany"&&(c=h.send(b).index(g));return g||(g=model["default"](b)||model.toS.camelize.constantize["new"]),d=[model.keys,a],f.merge({template:template,model:model,parentIndex:c,accessKeys:accessKeys,tabindex:tabindex}),(new Tower.View.Form.Builder(f)).render(block)},b.prototype.field=function(){var a,b,c,d,e,f;return a=Tower.Support.Array.args(arguments),e=a[a.length-1],(e===null||e===void 0)&&a.pop(),c=Tower.Support.Array.extractBlock(a),f=Tower.Support.Array.extractOptions(a),b=a.shift()||"attribute.name",d={template:this.template,model:this.model,attribute:b,parentIndex:this.parentIndex,index:this.index,fieldHTML:f.fieldHTML||{},inputHTML:f.inputHTML||{},labelHTML:f.labelHTML||{},errorHTML:f.errorHTML||{},hintHtml:f.hintHtml||{}},(new Tower.View.Form.Field([],_.extend(d,f))).render(c)},b.prototype.button=function(){var a,b,c;return a=Tower.Support.Array.args(arguments),b=Tower.Support.Array.extractBlock(a),c=Tower.Support.Array.extractOptions(a),c.as||(c.as="submit"),c.value=a.shift()||"Submit",c.as==="submit"&&(c["class"]=Tower.View.submitFieldsetClass),this.field(c.value,c,b)},b.prototype.submit=b.prototype.button,b.prototype.partial=function(a,b){return b==null&&(b={}),this.template.render({partial:a,locals:b.merge({fields:self})})},b.prototype.tag=function(){var a,b;return b=arguments[0],a=2<=arguments.length?__slice.call(arguments,1):[],this.template.tag(b,a)},b.prototype.render=function(a){return a(this)},b}(Tower.View.Component),Tower.View.Form.Field=function(a){function b(a,c){var d,e,f,g,h,i,j,k,l,m;this.labelValue=c.label,delete c.label,b.__super__.constructor.call(this,a,c),this.required||(this.required=!1),e=this.model.constructor.fields()[this.attribute],c.as||(c.as=e?Tower.Support.String.camelize(e.type,!0):"string"),this.inputType=f=c.as,this.required=!!e&&e.required===!0,d=[Tower.View.fieldClass,f],["submit","fieldset"].indexOf(f)>-1||(d.push(e.required?Tower.View.requiredClass:Tower.View.optionalClass),d.push(e.errors?Tower.View.errorClass:Tower.View.validClass),c.validate!==!1&&e.validations&&d.push(Tower.View.validateClass)),this.fieldHTML["class"]=this.addClass(this.fieldHTML["class"],d),!this.fieldHTML.id&&Tower.View.idEnabledOn.indexOf("field")>-1&&(this.fieldHTML.id=this.toId({type:"field",index:this.index,parentIndex:this.parentIndex})),this.inputHTML.id=this.toId({type:"input",index:this.index,parentIndex:this.parentIndex}),["hidden","submit"].indexOf(f)>-1||((i=this.labelHTML)["for"]||(i["for"]=this.inputHTML.id),this.labelHTML["class"]=this.addClass(this.labelHTML["class"],[Tower.View.labelClass]),this.labelValue!==!1&&(this.labelValue||(this.labelValue=Tower.Support.String.camelize(this.attribute.toString()))),c.hint!==!1&&(this.errorHTML["class"]=this.addClass(this.errorHTML["class"],[Tower.View.errorClass]),Tower.View.includeAria&&Tower.View.hintIsPopup&&((j=this.errorHTML).role||(j.role="tooltip")))),this.attributes=this.fieldHTML,f!=="submit"&&((k=this.inputHTML).name||(k.name=this.toParam())),this.value=c.value,this.dynamic=c.dynamic===!0,this.richInput=c.hasOwnProperty("rich_input")?!!c.rich_input:Tower.View.richInput,this.validate=c.validate!==!1,d=[f,Tower.Support.String.parameterize(this.attribute),this.inputHTML["class"]],["submit","fieldset"].indexOf(f)>-1||(d.push(e.required?Tower.View.requiredClass:Tower.View.optionalClass),d.push(e.errors?Tower.View.errorClass:Tower.View.validClass),d.push("input"),c.validate!==!1&&e.validations&&d.push(Tower.View.validateClass)),this.inputHTML["class"]=this.addClass(this.inputHTML["class"],d),c.placeholder&&(this.inputHTML.placeholder=c.placeholder),this.inputHTML.value==null&&(c.hasOwnProperty("value")&&(this.inputHTML.value=c.value),this.inputHTML.value==null&&(h=this.model.get(this.attribute),h&&(this.inputHTML.value=h))),c.hasOwnProperty("max")&&((l=this.inputHTML).maxlength||(l.maxlength=c.max)),g=c.match,_.isRegExp(g)&&(g=g.toString()),g!=null&&(this.inputHTML["data-match"]=g),this.inputHTML["aria-required"]=this.required.toString(),this.required===!0&&(this.inputHTML.required="true"),this.disabled&&(this.inputHTML.disabled="true"),this.autofocus===!0&&(this.inputHTML.autofocus="true"),this.dynamic&&(this.inputHTML["data-dynamic"]="true"),this.inputHTML.placeholder&&((m=this.inputHTML).title||(m.title=this.inputHTML.placeholder)),this.autocomplete=this.inputHTML.autocomplete===!0,this.autocomplete&&Tower.View.includeAria&&(this.inputHTML["aria-autocomplete"]=function(){switch(this.autocomplete){case"inline":case"list":case"both":return this.autocomplete;default:return"both"}}.call(this))}return __extends(b,a),b.prototype.addClass=function(a,b){var c,d,e,f;d=a?a.split(/\s+/g):[];for(f=0,e=b.length;f<e;f++){c=b[f];if(!c)continue;d.indexOf(c)>-1||d.push(c)}return d.join(" ")},b.prototype.toId=function(a){var b;return a==null&&(a={}),b=Tower.Support.String.parameterize(this.model.constructor.name),a.parentIndex&&(b+="-"+a.parentIndex),b+="-"+Tower.Support.String.parameterize(this.attribute),b+="-"+(a.type||"field"),this.index!=null&&(b+="-"+this.index),b},b.prototype.toParam=function(a){var b;return a==null&&(a={}),b=Tower.Support.String.parameterize(this.model.constructor.name),a.parentIndex&&(b+="["+a.parentIndex+"]"),b+="["+this.attribute+"]",this.index!=null&&(b+="["+this.index+"]"),b},b.prototype.input=function(){var a,b;return a=1<=arguments.length?__slice.call(arguments,0):[],b=_.extend(this.inputHTML,Tower.Support.Array.extractOptions(a)),key=a.shift()||this.attribute,this[""+this.inputType+"Input"](key,b)},b.prototype.checkboxInput=function(a,b){return this.tag("input",_.extend({type:"checkbox"},b))},b.prototype.stringInput=function(a,b){return this.tag("input",_.extend({type:"text"},b))},b.prototype.submitInput=function(a,b){return this.tag("input",_.extend({type:"submit"},b))},b.prototype.fileInput=function(a,b){return this.tag("input",_.extend({type:"file"},b))},b.prototype.textInput=function(a,b){return this.tag("textarea",b)},b.prototype.password_input=function(a,b){return this.tag("input",_.extend({type:"password"},b))},b.prototype.emailInput=function(a,b){return this.tag("input",_.extend({type:"email"},b))},b.prototype.urlInput=function(a,b){return this.tag("input",_.extend({type:"url"},b))},b.prototype.numberInput=function(a,b){return this.tag("input",_.extend({type:"string","data-type":"numeric"},b))},b.prototype.searchInput=function(a,b){return this.tag("input",_.extend({type:"search","data-type":"search"},b))},b.prototype.phoneInput=function(a,b){return this.tag("input",_.extend({type:"tel","data-type":"phone"},b))},b.prototype.label=function(){var a=this;if(!this.labelValue)return;return this.tag("label",this.labelHTML,function(){return a.tag("span",a.labelValue),a.required?a.tag("abbr",{title:Tower.View.requiredTitle,"class":Tower.View.requiredClass},function(){return Tower.View.requiredAbbr}):a.tag("abbr",{title:Tower.View.optionalTitle,"class":Tower.View.optionalClass},function(){return Tower.View.optionalAbbr})})},b.prototype.render=function(a){var b=this;return this.tag(Tower.View.fieldTag,this.attributes,function(){return a?a.call(b):(b.label(),b.input())})},b.prototype.extractElements=function(a){var b,c;return a==null&&(a={}),b=[],(typeof (c=["hidden","submit"]).include=="function"?c.include(inputType):void 0)?b.push("inputs"):(this.label.present!=null&&this.label.value!=null&&b.push("label"),b=b.concat(["inputs","hints","errors"])),b},b}(Tower.View.Component),Tower.View.Form.Fieldset=function(a){function b(a,c){var d;b.__super__.constructor.apply(this,arguments),this.attributes=d={},delete d.index,delete d.parentIndex,delete d.label,this.builder=new Tower.View.Form.Builder([],{template:this.template,model:this.model,attribute:this.attribute,index:this.index,parentIndex:this.parentIndex})}return __extends(b,a),b.prototype.render=function(a){var b=this;return this.tag("fieldset",this.attributes,function(){return b.label&&b.tag("legend",{"class":Tower.View.legendClass},function(){return b.tag("span",b.label)}),b.tag(Tower.View.fieldListTag,{"class":Tower.View.fieldListClass},function(){return b.builder.render(a)})})},b}(Tower.View.Component),Tower.View.AssetHelper={javascripts:function(){var a,b,c,d,e,f;d=1<=arguments.length?__slice.call(arguments,0):[],a=Tower.Support.Array.extractOptions(d),a.namespace="javascripts",a.extension="js",c=_extractAssetPaths(d,a);for(f=0,e=c.length;f<e;f++)b=c[f],javascriptTag(b);return null},javascript:function(){return javascript.apply(this,arguments)},stylesheets:function(){var a,b,c,d,e,f;d=1<=arguments.length?__slice.call(arguments,0):[],a=Tower.Support.Array.extractOptions(d),a.namespace="stylesheets",a.extension="css",c=_extractAssetPaths(d,a);for(f=0,e=c.length;f<e;f++)b=c[f],stylesheetTag(b);return null},stylesheet:function(){return stylesheets.apply(this,arguments)},_extractAssetPaths:function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o;b==null&&(b={}),e=b.namespace,c=b.extension,h=[];if(Tower.env==="production"){d=Tower.assetManifest;for(m=0,j=a.length;m<j;m++)i=a[m],i.match(/^(http|\/{2})/)||(i=""+i+"."+c,d[i]&&(i=d[i]),i="/assets/"+i,Tower.assetHost&&(i=""+Tower.assetHost+i)),h.push(i)}else for(n=0,k=a.length;n<k;n++){i=a[n];if(!i.match(/^(http|\/{2})/)){g=Tower.config.assets[e][i];if(g)for(o=0,l=g.length;o<l;o++)f=g[o],h.push("/"+e+f+"."+c)}else h.push(i)}return h},stylesheetTag:function(a){return link({rel:"stylesheet",href:a})},javascriptTag:function(a){return script({src:a})}},Tower.View.ComponentHelper={formFor:function(){var a;return(a=Tower.View.Form).render.apply(a,[__ck].concat(__slice.call(arguments)))},tableFor:function(){var a;return(a=Tower.View.Table).render.apply(a,[__ck].concat(__slice.call(arguments)))},widget:function(){},linkTo:function(b,c,d){return d==null&&(d={}),a(_.extend(d,{href:c,title:b}),b.toString())}},Tower.View.ElementHelper={title:function(a){return document.title=a},addClass:function(){var a,b,c,d,e,f;d=arguments[0],c=2<=arguments.length?__slice.call(arguments,1):[],a=d.split(/\ +/);for(f=0,e=c.length;f<e;f++)b=c[f],a.indexOf(b)>-1&&a.push(b);return a.join(" ")},elementId:function(){return"#"+this.elementKey.apply(this,arguments)},elementClass:function(){return"."+this.elementKey.apply(this,arguments)},elementKey:function(){return Tower.Support.String.parameterize(this.elementNameComponents.apply(this,arguments).join("-"))},elementName:function(){var a,b,c,d;c=this.elementNameComponents.apply(this,arguments),a=1;for(a=0,d=c.length;a<d;a++)b=c[a],c[a]="["+b+"]";return Tower.Support.String.parameterize(c.join(""))},elementNameComponents:function(){var a,b,c,d,e;a=Tower.Support.Array.args(arguments),c=[];for(e=0,d=a.length;e<d;e++){b=a[e];switch(typeof b){case"function":c.push(b.constructor.name);break;case"string":c.push(b);break;default:c.push(b.toString())}}return c}},Tower.View.HeadHelper={metaTag:function(a,b){return meta({name:a,content:b})},snapshotLinkTag:function(a){return linkTag({rel:"imageSrc",href:a})},html4ContentTypeTag:function(a,b){return a==null&&(a="UTF-8"),b==null&&(b="text/html"),httpMetaTag("Content-Type",""+b+"; charset="+a)},chromeFrameTag:function(){return html4ContentTypeTag(),meta({"http-equiv":"X-UA-Compatible",content:"IE=Edge,chrome=1"})},html5ContentTypeTag:function(a){return a==null&&(a="UTF-8"),meta({charset:a})},contentTypeTag:function(a){return html5ContentTypeTag(a)},csrfMetaTag:function(){return metaTag("csrf-token",this.request.session._csrf)},searchLinkTag:function(a,b){return linkTag({rel:"search",type:"application/opensearchdescription+xml",href:a,title:b})},faviconLinkTag:function(a){return a==null&&(a="/favicon.ico"),linkTag({rel:"shortcut icon",href:a,type:"image/x-icon"})},linkTag:function(a){return a==null&&(a={}),link(a)},ieApplicationMetaTags:function(a,b){var c;return b==null&&(b={}),c=[],c.push(metaTag("application-name",a)),b.hasOwnProperty("tooltip")&&c.push(metaTag("msapplication-tooltip",b.tooltip)),b.hasOwnProperty("url")&&c.push(metaTag("msapplication-starturl",b.url)),b.hasOwnProperty("width")&&b.hasOwnProperty("height")&&(c.push(metaTag("msapplication-window","width="+b.width+";height="+b.height)),b.hasOwnProperty("color")&&c.push(metaTag("msapplication-navbutton-color",b.color))),c.join("\n")},ieTaskMetaTag:function(a,b,c){var d;return c==null&&(c=null),d=[],d.push("name="+a),d.push("uri="+b),c&&d.push("icon-uri="+c),this.metaTag("msapplication-task",d.join(";"))},appleMetaTags:function(a){var b;return a==null&&(a={}),b=[],b.push(appleViewportMetaTag(a)),a.hasOwnProperty("fullScreen")&&b.push(appleFullScreenMetaTag(a.fullScreen)),a.hasOwnProperty("mobile")&&b.push(appleMobileCompatibleMetaTag(a.mobile)),b.join()},appleViewportMetaTag:function(a){var b;return a==null&&(a={}),b=[],a.hasOwnProperty("width")&&b.push("width="+a.width),a.hasOwnProperty("height")&&b.push("height="+a.height),b.push("initial-scale="+(a.scale||1)),a.hasOwnProperty("min")&&b.push("minimum-scale="+a.min),a.hasOwnProperty("max")&&b.push("maximum-scale="+a.max),a.hasOwnProperty("scalable")&&b.push("user-scalable="+boolean(a.scalable)),metaTag("viewport",b.join(", "))},appleFullScreenMetaTag:function(a){return metaTag("apple-touch-fullscreen",boolean(a))},appleMobileCompatibleMetaTag:function(a){return metaTag("apple-mobile-web-app-capable",boolean(a))},appleTouchIconLinkTag:function(a,b){var c;return b==null&&(b={}),c=["apple-touch-icon"],b.hasOwnProperty("size")&&c.push(""+b.size+"x"+b.size),b.precomposed&&c.push("precomposed"),linkTag({rel:c.join("-"),href:a})},appleTouchIconLinkTags:function(){var a,b,c,d,e,f,g;b=arguments[0],e=2<=arguments.length?__slice.call(arguments,1):[],typeof e[e.length-1]=="object"?a=e.pop():a={},c=[];for(g=0,f=e.length;g<f;g++)d=e[g],c.push(appleTouchIconLinkTag(b,_.extend({size:d},a)));return c.join()},openGraphMetaTags:function(a){return a==null&&(a={}),a.title&&openGraphMetaTag("og:title",a.title),a.type&&openGraphMetaTag("og:type",a.type),a.image&&openGraphMetaTag("og:image",a.image),a.site&&openGraphMetaTag("og:siteName",a.site),a.description&&openGraphMetaTag("og:description",a.description),a.email&&openGraphMetaTag("og:email",a.email),a.phone&&openGraphMetaTag("og:phoneNumber",a.phone),a.fax&&openGraphMetaTag("og:faxNumber",a.fax),a.lat&&openGraphMetaTag("og:latitude",a.lat),a.lng&&openGraphMetaTag("og:longitude",a.lng),a.street&&openGraphMetaTag("og:street-address",a.street),a.city&&openGraphMetaTag("og:locality",a.city),a.state&&openGraphMetaTag("og:region",a.state),a.zip&&openGraphMetaTag("og:postal-code",a.zip),a.country&&openGraphMetaTag("og:country-name",a.country),null},openGraphMetaTag:function(a,b){return meta({property:a,content:b})}},Tower.View.RenderingHelper={partial:function(path,options,callback){var item,locals,name,prefixes,template,tmpl,_len5,_m,_ref5;try{typeof options=="function"&&(callback=options,options={}),options||(options={}),options.locals||(options.locals={}),locals=options.locals,path=path.split("/"),path[path.length-1]="_"+path[path.length-1],path=path.join("/"),prefixes=options.prefixes,this._context&&(prefixes||(prefixes=[this._context.collectionName])),template=this._readTemplate(path,prefixes,options.type||Tower.View.engine),template=this.renderWithEngine(String(template));if(options.collection){name=options.as||Tower.Support.String.camelize(options.collection[0].constructor.name,!0),tmpl=eval("(function(data) { with(data) { this."+name+" = "+name+"; "+String(template)+" } })"),_ref5=options.collection;for(_m=0,_len5=_ref5.length;_m<_len5;_m++)item=_ref5[_m],locals[name]=item,tmpl.call(this,locals),delete this[name]}else tmpl="(function(data) { with(data) { "+String(template)+" } })",eval(tmpl).call(this,locals)}catch(error){console.log(error.stack||error)}return null},page:function(){var a,b,c;return a=Tower.Support.Array.args(arguments),c=Tower.Support.Array.extractOptions(a),b=a.shift()||c.title,this.contentFor("title",function(){return title(b)})},urlFor:function(){return Tower.urlFor.apply(Tower,arguments)},yields:function(key){var ending,value;return value=this[key],typeof value=="function"?eval("("+String(value)+")()"):(ending=value.match(/\n$/)?"\n":"",text(value.replace(/\n$/,"").replace(/^(?!\s+$)/mg,__ck.repeat("  ",__ck.tabs))+ending)),null},hasContentFor:function(a){return!!this.hasOwnProperty(a)&&!!this[a]&&this[a]!==""},has:function(a){return!!this.hasOwnProperty(a)&&!!this[a]&&this[a]!==""},contentFor:function(a,b){return this[a]=b,null}},Tower.View.StringHelper={HTML_ESCAPE:{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"},preserve:function(a){return a.replace(/\n/g,"&#x000A;").replace(/\r/g,"")},htmlEscape:function(a){var b=this;return a.replace(/[\"><&]/g,function(a){return b.HTML_ESCAPE[a]})},t:function(a){return Tower.Support.I18n.translate(a)},l:function(a){return Tower.Support.I18n.localize(string)},"boolean":function(a){return a?"yes":"no"}},Tower.View.include(Tower.View.Rendering),Tower.View.include(Tower.View.Helpers),Tower.View.include(Tower.View.AssetHelper),Tower.View.include(Tower.View.ComponentHelper),Tower.View.include(Tower.View.HeadHelper),Tower.View.include(Tower.View.RenderingHelper),Tower.View.include(Tower.View.StringHelper),Tower.View.helpers.push(Tower.View.AssetHelper),Tower.View.helpers.push(Tower.View.ComponentHelper),Tower.View.helpers.push(Tower.View.HeadHelper),Tower.View.helpers.push(Tower.View.RenderingHelper),Tower.View.helpers.push(Tower.View.StringHelper),$.fn.serializeParams=function(a){return $.serializeParams($(this).serialize(),a)},$.serializeParams=function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n;k={},d={"true":!0,"false":!1,"null":null},c=a.replace(/\+/g," ").split("&");for(g=0,n=c.length;g<n;g++){h=c[g],l=h.split("="),key=decodeURIComponent(l[0]),m=void 0,e=k,f=0,i=key.split("]["),j=i.length-1,/\[/.test(i[0])&&/\]$/.test(i[j])?(i[j]=i[j].replace(/\]$/,""),i=i.shift().split("[").concat(i),j=i.length-1):j=0;if(l.length===2){m=decodeURIComponent(l[1]),b&&(m=m&&!isNaN(m)?+m:m==="undefined"?undefined:d[m]!==undefined?d[m]:m);if(j)while(f<=j)key=i[f]===""?e.length:i[f],e=e[key]=f<j?e[key]||(i[f+1]&&isNaN(i[f+1])?{}:[]):m,f++;else $.isArray(k[key])?k[key].push(m):k[key]!==undefined?k[key]=[k[key],m]:k[key]=m}else key&&(k[key]=b?undefined:"")}return k},Tower.View.MetaHelper={title:function(a){return document.title=a}},Tower.View.ValidationHelper={success:function(){return this.redirectTo("/")},failure:function(a){return a?this.flashError(a):this.invalidate()},invalidate:function(){var a,b,c,d,e,f;b=$("#"+this.resourceName+"-"+this.elementName),e=this.resource.errors,f=[];for(a in e)c=e[a],d=$("#"+this.resourceName+"-"+a+"-field"),d.length?(d.css("background","yellow"),f.push($("input",d).after("<output class='error'>"+c.join("\n")+"</output>"))):f.push(void 0);return f}},Tower.Controller=function(a){function b(){this.constructor._instance=this,this.headers={},this.status=200,this.request=null,this.response=null,this.params={},this.query={},this.resourceName=this.constructor.resourceName(),this.resourceType=this.constructor.resourceType(),this.collectionName=this.constructor.collectionName(),this.formats=_.keys(this.constructor.mimes()),this.constructor._belongsTo?this.hasParent=!0:this.hasParent=!1}return __extends(b,a),b.include(Tower.Support.Callbacks),b.extend(Tower.Support.EventEmitter),b.include(Tower.Support.EventEmitter),b.instance=function(){return this._instance||(this._instance=new this)},b.metadata=function(){return this._metadata||(this._metadata={})},b}(Tower.Class),Tower.Controller.Callbacks={ClassMethods:{beforeAction:function(){return this.before.apply(this,["action"].concat(__slice.call(arguments)))},afterAction:function(){return this.after.apply(this,["action"].concat(__slice.call(arguments)))}}},Tower.Controller.Helpers={ClassMethods:{helper:function(a){return this._helpers||(this._helpers=[]),this._helpers.push(a)},layout:function(a){return this._layout=a}},layout:function(){var a;return a=this.constructor._layout,typeof a=="function"?a.call(this):a}},Tower.Controller.Instrumentation={call:function(a,b,c){return this.request=a,this.response=b,this.params=this.request.params||{},this.cookies=this.request.cookies||{},this.query=this.request.query||{},this.session=this.request.session||{},this.format=this.params.format||"html",this.action=this.params.action,this.headers={},this.callback=c,this.process()},process:function(){var a=this;return this.processQuery(),Tower.env.match(/(test|production)/)||(console.log("  Processing by "+this.constructor.name+"#"+this.action+" as "+this.format.toUpperCase()),console.log("  Parameters:"),console.log(this.params)),this.runCallbacks("action",{name:this.action},function(b){return a[a.action].call(a,b)})},processQuery:function(){},clear:function(){return this.request=null,this.response=null,this.headers=null}},Tower.Controller.Params={ClassMethods:{params:function(a,b){return typeof a=="function"&&(b=a,a={}),a&&(this._paramsOptions=Tower.Support.Object.extend(this._paramsOptions||{},a),b.call(this)),this._params||(this._params={})},param:function(a,b){return b==null&&(b={}),this._params||(this._params={}),this._params[a]=Tower.HTTP.Param.create(a,Tower.Support.Object.extend({},this._paramsOptions||{},b))}},criteria:function(){var a,b,c,d,e;if(this._criteria)return this._criteria;this._criteria=a=new Tower.Model.Criteria,e=this.constructor.params(),c=this.params;for(b in e)d=e[b],c.hasOwnProperty(b)&&a.where(d.toCriteria(c[b]));return a}},Tower.Controller.Redirecting={redirectTo:function(){return this.redirect.apply(this,arguments)},redirect:function(){var a;(a=this.response).redirect.apply(a,arguments);if(this.callback)return this.callback()}},Tower.Controller.Rendering={ClassMethods:{addRenderer:function(a,b){return this.renderers()[a]=b},addRenderers:function(a){var b,c;a==null&&(a={});for(c in a)b=a[c],this.addRenderer(c,b);return this},renderers:function(){return this._renderers||(this._renderers={})}},render:function(){return this.renderToBody(this._normalizeRender.apply(this,arguments))},renderToBody:function(a){return this._processRenderOptions(a),this._renderTemplate(a)},renderToString:function(){return this.renderToBody(this._normalizeRender.apply(this,arguments))},sendFile:function(a,b){b==null&&(b={})},sendData:function(a,b){b==null&&(b={})},_renderTemplate:function(a){var b,c,d,e,f=this;e=a.callback,b=function(a,b){a?(f.status||(f.status=404),f.body=a.stack):(f.status||(f.status=200),f.body=b),e&&e.apply(f,arguments);if(f.callback)return f.callback()};if(this._handleRenderers(a,b))return;(d=this.headers)["Content-Type"]||(d["Content-Type"]="text/html"),c=new Tower.View(this);try{return c.render.call(c,a,b)}catch(g){return b(g)}},_handleRenderers:function(a,b){var c,d,e;e=Tower.Controller.renderers();for(c in e){d=e[c];if(a.hasOwnProperty(c))return d.call(this,a[c],a,b),!0}return!1},_processRenderOptions:function(a){return a==null&&(a={}),a.status&&(this.status=a.status),a.contentType&&(this.headers["Content-Type"]=a.contentType),a.location&&(this.headers.Location=this.urlFor(a.location)),this},_normalizeRender:function(){return this._normalizeOptions(this._normalizeArgs.apply(this,arguments))},_normalizeArgs:function(){var a,b,c,d;return b=Tower.Support.Array.args(arguments),typeof b[0]=="string"&&(a=b.shift()),typeof b[0]=="object"&&(d=b.shift()),typeof b[0]=="function"&&(c=b.shift()),d||(d={}),a&&(key=a.match(/\//)?"file":"action",d[key]=a),c&&(d.callback=c),d},_normalizeOptions:function(a){return a==null&&(a={}),a.partial===!0&&(a.partial=this.action),a.prefixes||(a.prefixes=[]),a.prefixes.push(this.collectionName),a.template||(a.template=a.file||a.action||this.action),a}},Tower.Controller.Resourceful={ClassMethods:{resource:function(a){return a.hasOwnProperty("name")&&(this._resourceName=a.name),a.hasOwnProperty("type")&&(this._resourceType=a.type),a.hasOwnProperty("collectionName")&&(this._collectionName=a.collectionName),this},resourceType:function(){return this._resourceType||(this._resourceType=Tower.Support.String.singularize(this.name.replace(/(Controller)$/,"")))},resourceName:function(){var a;return this._resourceName?this._resourceName:(a=this.resourceType().split("."),this._resourceName=Tower.Support.String.camelize(a[a.length-1],!0))},collectionName:function(){return this._collectionName||(this._collectionName=Tower.Support.String.camelize(this.name.replace(/(Controller)$/,""),!0))},belongsTo:function(a,b){return b==null&&(b={}),b.key=a,b.type||(b.type=Tower.Support.String.camelize(b.key)),this._belongsTo=b},actions:function(){var a,b,c,d,e,f,g;d=Tower.Support.Array.args(arguments),typeof d[d.length-1]=="object"?e=d.pop():e={},b=["index","new","create","show","edit","update","destroy"],c=_.difference(b,d,e.except||[]);for(g=0,f=c.length;g<f;g++)a=c[g],this[a]=null,delete this[a];return this}},index:function(){var a=this;return this._index(function(b){return b.html(function(){return a.render("index")}),b.json(function(){return a.render({json:a.collection,status:200})})})},"new":function(){var a=this;return this._new(function(b){return b.html(function(){return a.render("new")}),b.json(function(){return a.render({json:a.resource,status:200})})})},create:function(){var a=this;return this._create(function(b){return b.html(function(){return a.redirectTo({action:"show"})}),b.json(function(){return a.render({json:a.resource,status:200})})})},show:function(){var a=this;return this._show(function(b){return b.html(function(){return a.render("show")}),b.json(function(){return a.render({json:a.resource,status:200})})})},edit:function(){var a=this;return this._edit(function(b){return b.html(function(){return a.render("edit")}),b.json(function(){return a.render({json:a.resource,status:200})})})},update:function(){var a=this;return this._update(function(b){return b.html(function(){return a.redirectTo({action:"show"})}),b.json(function(){return a.render({json:a.resource,status:200})})})},destroy:function(){var a=this;return this._destroy(function(b){return b.html(function(){return a.redirectTo({action:"index"})}),b.json(function(){return a.render({json:a.resource,status:200})})})},_index:function(a){var b=this;return this.findCollection(function(c,d){return b.respondWith(d,a)})},_new:function(a){var b=this;return this.buildResource(function(c,d){return d?b.respondWith(d,a):b.failure(c)})},_create:function(a){var b=this;return this.buildResource(function(c,d){return d?d.save(function(c){return b.respondWithStatus(Tower.Support.Object.isBlank(d.errors),a)}):b.failure(c,a)})},_show:function(a){var b=this;return this.findResource(function(c,d){return b.respondWith(d,a)})},_edit:function(a){var b=this;return this.findResource(function(c,d){return b.respondWith(d,a)})},_update:function(a){var b=this;return this.findResource(function(c,d){return c?b.failure(c,a):d.updateAttributes(b.params[b.resourceName],function(c){return b.respondWithStatus(!c&&Tower.Support.Object.isBlank(d.errors),a)})})},_destroy:function(a){var b=this;return this.findResource(function(c,d){return c?b.failure(c,a):d.destroy(function(c){return b.respondWithStatus(!c,a)})})},respondWithScoped:function(a){var b=this;return this.scoped(function(c,d){return c?b.failure(c,a):b.respondWith(d.build(),a)})},respondWithStatus:function(a,b){var c,d,e;return d={records:this.resource||this.collection},b&&b.length>1?(e=new Tower.Controller.Responder(this,d),c=new Tower.Controller.Responder(this,d),b.call(this,e,c),a?e[format].call(this):c[format].call(this,error)):Tower.Controller.Responder.respond(this,d,b)},buildResource:function(a){var b=this;return this.scoped(function(c,d){var e;return c?a.call(b,c,null):(b[b.resourceName]=b.resource=e=d.build(b.params[b.resourceName]),a&&a.call(b,null,e),e)})},findResource:function(a){var b=this;return this.scoped(function(c,d){return c?a.call(b,c,null):d.find(b.params.id,function(c,d){return b[b.resourceName]=b.resource=d,a.call(b,c,d)})})},findCollection:function(a){var b=this;return this.scoped(function(c,d){return c?a.call(b,c,null):d.all(function(c,d){b[b.collectionName]=b.collection=d;if(a)return a.call(b,c,d)})})},findParent:function(a){var b,c,d,e=this;return b=this.constructor._belongsTo,b?(c=b.param||""+b.key+"Id",d=Tower.constant(b.type),d.find(this.params[c],function(c,d){if(c&&!a)throw c;c||(e.parent=e[b.key]=d);if(a)return a.call(e,c,d)})):(a&&a.call(this,null,!1),!1)},scoped:function(a){var b,c=this;return b=function(b,d){return a.call(c,b,d.where(c.criteria()))},this.hasParent?this.findParent(function(a,d){return b(a,d[c.collectionName]())}):b(null,Tower.constant(this.resourceType))},failure:function(a,b){return b()}},Tower.Controller.Responder=function(){function a(a,b){var c,d,e,f;b==null&&(b={}),this.controller=a,this.options=b,f=this.controller.formats;for(e=0,d=f.length;e<d;e++)c=f[e],this.accept(c)}return a.respond=function(a,b,c){var d;return d=new this(a,b),d.respond(c)},a.prototype.accept=function(a){return this[a]=function(b){return this["_"+a]=b}},a.prototype.respond=function(a){var b;return a&&a.call(this.controller,this),b=this["_"+this.controller.format],b?b.call(this):this.toFormat()},a.prototype._html=function(){return this.controller.render({action:this.controller.action})},a.prototype._json=function(){return this.controller.render({json:this.options.records})},a.prototype.toFormat=function(){try{return typeof get!="undefined"&&get!==null||typeof hasErrors=="undefined"||hasErrors===null?this.defaultRender():this.displayErrors()}catch(a){return this._apiBehavior(a)}},a.prototype._navigationBehavior=function(a){if(typeof get!="undefined"&&get!==null)throw a;return typeof hasErrors!="undefined"&&hasErrors!==null&&defaultAction?this.render({action:this.defaultAction}):this.redirectTo(this.navigationLocation)},a.prototype._apiBehavior=function(a){return typeof get!="undefined"&&get!==null?this.display(resource):typeof post!="undefined"&&post!==null?this.display(resource,{status:"created",location:this.apiLocation}):this.head("noContent")},a.prototype.isResourceful=function(){return this.resource.hasOwnProperty("to"+this.format.toUpperCase())},a.prototype.resourceLocation=function(){return this.options.location||this.resources},a.prototype.defaultRender=function(){return this.defaultResponse.call(options)},a.prototype.display=function(a,b){return b==null&&(b={}),this.controller.render(_.extend(b,this.options,{format:this.resource}))},a.prototype.displayErrors=function(){return this.controller.render({format:this.resourceErrors,status:"unprocessableEntity"})},a.prototype.hasErrors=function(){var a;return(typeof (a=this.resource).respondTo=="function"?a.respondTo("errors"):void 0)&&this.resource.errors.empty==null},a.prototype.defaultAction=function(){return this.action||(this.action=ACTIONS_FOR_VERBS[request.requestMethodSymbol])},a.prototype.resourceErrors=function(){return this.hasOwnProperty(""+format+"ResourceErrors")?this[""+format+"RresourceErrors"]:this.resource.errors},a.prototype.jsonResourceErrors=function(){return{errors:this.resource.errors}},a}(),Tower.Controller.Responding={ClassMethods:{respondTo:function(){var a,b,c,d,e,f,g,h;c=this.mimes(),a=Tower.Support.Array.args(arguments),typeof a[a.length-1]=="object"?f=a.pop():f={},f.only&&(e=Tower.Support.Object.toArray(f.only)),f.except&&(b=Tower.Support.Object.toArray(f.except));for(h=0,g=a.length;h<g;h++)d=a[h],c[d]={},e&&(c[d].only=e),b&&(c[d].except=b);return this},mimes:function(){return this._mimes||(this._mimes={json:{},html:{}})}},respondTo:function(a){return Tower.Controller.Responder.respond(this,{},a)},respondWith:function(){var a,b,c;return a=Tower.Support.Array.args(arguments),b=null,typeof a[a.length-1]=="function"&&(b=a.pop()),typeof a[a.length-1]!="object"||a[a.length-1]instanceof Tower.Model?c={}:c=a.pop(),c||(c={}),c.records=a[0],Tower.Controller.Responder.respond(this,c,b)},_mimesForAction:function(){var a,b,c,d,e,f;a=this.action,e=[],d=this.constructor.mimes();for(c in d)b=d[c],f=!1,b.except?f=!_.include(b.except,a):b.only?f=_.include(b.only,a):f=!0,f&&e.push(c);return e}},Tower.Controller.include(Tower.Controller.Callbacks),Tower.Controller.include(Tower.Controller.Helpers),Tower.Controller.include(Tower.Controller.Instrumentation),Tower.Controller.include(Tower.Controller.Params),Tower.Controller.include(Tower.Controller.Redirecting),Tower.Controller.include(Tower.Controller.Rendering),Tower.Controller.include(Tower.Controller.Resourceful),Tower.Controller.include(Tower.Controller.Responding),Tower.Controller.Elements={ClassMethods:{extractElements:function(a,b){var c,d,e,f,g;b==null&&(b={}),e={};for(d in b){g=b[d];for(c in g)f=g[c],e[c]=a[d](f)}return e},processElements:function(a,b){return b==null&&(b={}),this.elements=this.extractElements(a,b)},clickHandler:function(a,b,c){var d=this;return $(this.dispatcher).on(a,function(a){})},submitHandler:function(a,b,c){var d=this;return $(this.dispatcher).on(a,function(a){var c,e,f,g,h,i;try{i=$(a.target),f=i.closest("form"),c=f.attr("action"),g=(f.attr("data-method")||f.attr("method")).toUpperCase(),h=f.serializeParams(),h.method=g,h.action=c,e=_.extend({target:i,form:f},{}),d._dispatch(b,{elements:e,params:h})}catch(j){console.log(j)}return!1})},invalidForm:function(){var a,b,c,d,e,f;b=$("#"+this.resourceName+"-"+this.elementName),e=this.resource.errors,f=[];for(a in e)c=e[a],d=$("#"+this.resourceName+"-"+a+"-field"),d.length?(d.css("background","yellow"),f.push($("input",d).after("<output class='error'>"+c.join("\n")+"</output>"))):f.push(void 0);return f}}},Tower.Controller.Events={ClassMethods:{DOM_EVENTS:["click","dblclick","blur","error","focus","focusIn","focusOut","hover","keydown","keypress","keyup","load","mousedown","mouseenter","mouseleave","mousemove","mouseout","mouseover","mouseup","mousewheel","ready","resize","scroll","select","submit","tap","taphold","swipe","swipeleft","swiperight"],dispatcher:global,addEventHandler:function(a,b,c){return c.type==="socket"||!a.match(this.DOM_EVENT_PATTERN)?this.addSocketEventHandler(a,b,c):this.addDomEventHandler(a,b,c)},socketNamespace:function(){return Tower.Support.String.pluralize(Tower.Support.String.camelize(this.name.replace(/(Controller)$/,""),!1))},addSocketEventHandler:function(a,b,c){var d=this;return this.io||(this.io=Tower.Application.instance().io.connect(this.socketNamespace())),this.io.on(a,function(a){return d._dispatch(void 0,b,a)})},addDomEventHandler:function(a,b,c){var d,e,f,g,h=this;return f=a.split(/\ +/),a=f.shift(),g=f.join(" "),g&&g!==""&&(c.target=g),c.target||(c.target="body"),d=a.split(/[\.:]/)[0],e=this[""+d+"Handler"],e?e.call(this,a,b,c):$(this.dispatcher).on(a,c.target,function(a){return h._dispatch(b,c)}),this},_dispatch:function(a,b){var c;return b==null&&(b={}),c=this.instance(),c.elements||(c.elements={}),c.params||(c.params={}),b.params&&_.extend(c.params,b.params),b.elements&&_.extend(c.elements,b.elements),typeof a=="string"?c[a].call(c,event):a.call(c,event)}}},Tower.Controller.Events.ClassMethods.DOM_EVENT_PATTERN=new RegExp("^("+Tower.Controller.Events.ClassMethods.DOM_EVENTS.join("|")+")"),Tower.Controller.Handlers={ClassMethods:{submitHandler:function(a,b,c){var d=this;return $(this.dispatcher).on(a,function(a){var c,e,f,g,h,i;return i=$(a.target),f=i.closest("form"),c=f.attr("action"),g=(f.attr("data-method")||f.attr("method")).toUpperCase(),h=f.serializeParams(),h.method=g,h.action=c,e=_.extend({target:i,form:f},{}),d._dispatch(b,{elements:e,params:h})})}}},Tower.Controller.include(Tower.Controller.Elements),Tower.Controller.include(Tower.Controller.Events),Tower.Controller.include(Tower.Controller.Handlers),$.fn.serializeParams=function(a){return $.serializeParams($(this).serialize(),a)},$.serializeParams=function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n;k={},d={"true":!0,"false":!1,"null":null},c=a.replace(/\+/g," ").split("&");for(g=0,n=c.length;g<n;g++){h=c[g],l=h.split("="),key=decodeURIComponent(l[0]),m=void 0,e=k,f=0,i=key.split("]["),j=i.length-1,/\[/.test(i[0])&&/\]$/.test(i[j])?(i[j]=i[j].replace(/\]$/,""),i=i.shift().split("[").concat(i),j=i.length-1):j=0;if(l.length===2){m=decodeURIComponent(l[1]),b&&(m=m&&!isNaN(m)?+m:m==="undefined"?undefined:d[m]!==undefined?d[m]:m);if(j)while(f<=j)key=i[f]===""?e.length:i[f],e=e[key]=f<j?e[key]||(i[f+1]&&isNaN(i[f+1])?{}:[]):m,f++;else $.isArray(k[key])?k[key].push(m):k[key]!==undefined?k[key]=[k[key],m]:k[key]=m}else key&&(k[key]=b?undefined:"")}return k},Tower.HTTP={},Tower.HTTP.Agent=function(){function a(a){a==null&&(a={}),_.extend(this,a)}return a.prototype.toJSON=function(){return{family:this.family,major:this.major,minor:this.minor,patch:this.patch,version:this.version,os:this.os,name:this.name}},a}(),Tower.HTTP.Cookies=function(){function a(a){var b,c;a==null&&(a={});for(b in a)c=a[b],this[b]=c}return a.parse=function(a){var b,c,d,e,f,g,h;a==null&&(a=document.cookie),e={},d=a.split(/[;,] */);for(h=0,g=d.length;h<g;h++){c=d[h],b=c.indexOf("="),key=c.substring(0,b).trim().toLowerCase(),f=c.substring(++b,c.length).trim(),'"'===f[0]&&(f=f.slice(1,-1));if(e[key]===void 0){f=f.replace(/\+/g," ");try{e[key]=decodeURIComponent(f)}catch(i){if(i instanceof URIError)e[key]=f;else throw err}}}return new this(e)},a}(),Tower.HTTP.Param=function(){function a(a,b){b==null&&(b={}),this.controller=b.controller,this.key=a,this.attribute=b.as||this.key,this.modelName=b.modelName,typeof modelName!="undefined"&&modelName!==null&&(this.namespace=Tower.Support.String.pluralize(this.modelName)),this.exact=b.exact||!1,this["default"]=b["default"]}return a.perPage=20,a.sortDirection="ASC",a.sortKey="sort",a.limitKey="limit",a.pageKey="page",a.separator="_",a.create=function(a,b){return b.type||(b.type="String"),new Tower.HTTP.Param[b.type](a,b)},a.prototype.parse=function(a){return a},a.prototype.render=function(a){return a},a.prototype.toCriteria=function(a){var b,c,d,e,f,g,h,i,j,k,l;f=this.parse(a),d=new Tower.Model.Criteria;for(k=0,i=f.length;k<i;k++){h=f[k];for(l=0,j=h.length;l<j;l++)e=h[l],b=e.attribute,g=e.operators[0],c={},g==="$eq"?c[b]=e.value:(c[b]={},c[b][g]=e.value),d.where(c)}return d},a.prototype.parseValue=function(a,b){return{namespace:this.namespace,key:this.key,operators:b,value:a,attribute:this.attribute}},a.prototype._clean=function(a){return a.replace(/^-/,"").replace(/^\+-/,"").replace(/^'|'$/,"").replace("+"," ").replace(/^\^/,"").replace(/\$$/,"").replace(/^\s+|\s+$/,"")},a}(),Tower.HTTP.Param.Array=function(a){function b(){b.__super__.constructor.apply(this,arguments)}return __extends(b,a),b.prototype.parse=function(a){var b,c,d,e,f,g,h,i=this;f=[],b=a.toString().split(/[,\|]/);for(h=0,g=b.length;h<g;h++)e=b[h],c=!1,d=!!e.match(/^\^/),e=e.replace(/^\^/,""),e.replace(/([^\.]+)?(\.{2})([^\.]+)?/,function(a,b,d,e){var g;return c=!0,g=[],!!b&&!!b.match(/^\d/)&&g.push(i.parseValue(b,["$gte"])),!!e&&!!e.match(/^\d/)&&g.push(i.parseValue(e,["$lte"])),f.push(g)}),c||f.push([this.parseValue(e,["$eq"])]);return f},b}(Tower.HTTP.Param),Tower.HTTP.Param.Date=function(a){function b(){b.__super__.constructor.apply(this,arguments)}return __extends(b,a),b.prototype.parse=function(a){var b,c,d,e,f,g,h=this;e=[],b=a.toString().split(/[\s,\+]/);for(g=0,f=b.length;g<f;g++)d=b[g],c=!1,d.replace(/([^\.]+)?(\.\.)([^\.]+)?/,function(a,b,d,f){var g;return c=!0,g=[],!!b&&!!b.match(/^\d/)&&g.push(h.parseValue(b,["$gte"])),!!f&&!!f.match(/^\d/)&&g.push(h.parseValue(f,["$lte"])),e.push(g)}),c||e.push([this.parseValue(d,["$eq"])]);return e},b.prototype.parseValue=function(a,c){return b.__super__.parseValue.call(this,Tower.date(a),c)},b}(Tower.HTTP.Param),Tower.HTTP.Param.Number=function(a){function b(){b.__super__.constructor.apply(this,arguments)}return __extends(b,a),b.prototype.parse=function(a){var b,c,d,e,f,g,h,i=this;f=[],b=a.toString().split(/[,\|]/);for(h=0,g=b.length;h<g;h++)e=b[h],c=!1,d=!!e.match(/^\^/),e=e.replace(/^\^/,""),e.replace(/([^\.]+)?(\.{2})([^\.]+)?/,function(a,b,d,e){var g;return c=!0,g=[],!!b&&!!b.match(/^\d/)&&g.push(i.parseValue(b,["$gte"])),!!e&&!!e.match(/^\d/)&&g.push(i.parseValue(e,["$lte"])),f.push(g)}),c||f.push([this.parseValue(e,["$eq"])]);return f},b.prototype.parseValue=function(a,c){return b.__super__.parseValue.call(this,parseFloat(a),c)},b}(Tower.HTTP.Param),Tower.HTTP.Param.String=function(a){function b(){b.__super__.constructor.apply(this,arguments)}return __extends(b,a),b.prototype.parse=function(a){var b,c,d,e,f,g=this;b=a.split(/(?:[\s|\+]OR[\s|\+]|\||,)/);for(c=0,f=b.length;c<f;c++)d=b[c],e=[],d.replace(/([\+\-\^]?[\w@_\s\d\.\$]+|-?\'[\w@-_\s\d\+\.\$]+\')/g,function(a,b){var c,d,f;return d=!1,c=!1,b=b.replace(/^(\+?-+)/,function(a,b){return d=b&&b.length>0,""}),b=b.replace(/^\'(.+)\'$/,function(a,b){return c=b&&b.length>0,b}),d?f=[c?"$neq":"$notMatch"]:f=[c?"$eq":"$match"],!b.match(/^\+?\-?\^/)||f.push("^"),!b.match(/\$$/)||f.push("$"),e.push(g.parseValue(g._clean(b),f)),a}),b[c]=e;return b},b}(Tower.HTTP.Param),Tower.HTTP.Route=function(a){function b(a){a||(a=a),this.path=a.path,this.name=a.name,this.method=(a.method||"GET").toUpperCase(),this.ip=a.ip,this.defaults=a.defaults||{},this.constraints=a.constraints,this.options=a,this.controller=a.controller,this.keys=[],this.pattern=this.extractPattern(this.path),this.id=this.path,this.controller&&(this.id+=this.controller.name+this.controller.action)}return __extends(b,a),b.store=function(){return this._store||(this._store=[])},b.create=function(a){return this.store().push(a)},b.all=function(){return this.store()},b.clear=function(){return this._store=[]},b.draw=function(a){return a.apply(new Tower.HTTP.Route.DSL(this))},b.findController=function(a,b,c){var d,e,f,g,h;f=Tower.Route.all();for(h=0,g=f.length;h<g;h++){e=f[h],d=e.toController(a);if(d)break}return d?d.call(a,b,function(){return c(d)}):c(null),d},b.prototype.toController=function(a){var b,c,d,e,f,g,h,i,j;f=this.match(a);if(!f)return null;g=a.method.toLowerCase(),e=this.keys,h=Tower.Support.Object.extend({},this.defaults,a.query||{},a.body||{}),f=f.slice(1);for(d=0,i=f.length;d<i;d++)b=f[d],h[j=e[d].name]||(h[j]=b?decodeURIComponent(b):null);return c=this.controller,c&&(h.action=c.action),a.params=h,c&&(c=new(Tower.constant(Tower.namespaced(this.controller.className)))),c},b.prototype.match=function(a){var b,c;return typeof a=="string"?this.pattern.exec(a):(c=a.location.path,a.method.toUpperCase()!==this.method?null:(b=this.pattern.exec(c),b?this.matchConstraints(a)?b:null:null))},b.prototype.matchConstraints=function(a){var b,c,d;b=this.constraints;switch(typeof b){case"object":for(c in b){d=b[c];switch(typeof d){case"string":case"number":if(a[c]!==d)return!1;break;case"function":case"object":if(!a.location[c].match(d))return!1}}break;case"function":return b.call(a,a);default:return!1}return!0},b.prototype.urlFor=function(a){var b,c,d;a==null&&(a={}),c=this.path;for(b in a)d=a[b],c=c.replace(new RegExp(":"+b+"\\??","g"),d);return c=c.replace(new RegExp("\\.?:\\w+\\??","g"),""),c},b.prototype.extractPattern=function(a,b,c){var d;return a instanceof RegExp?a:(d=this,a==="/"?new RegExp("^"+a+"$"):(a=a.replace(/(\(?)(\/)?(\.)?([:\*])(\w+)(\))?(\?)?/g,function(a,b,c,e,f,g,h,i){var j,k;i=!!i||b+h==="()",k=f==="*",d.keys.push({name:g,optional:!!i,splat:k}),c||(c=""),j="";if(!i||!k)j+=c;return j+="(?:",e!=null?j+=k?"\\.([^.]+?)":"\\.([^/.]+?)":j+=k?"/?(.+)":"([^/\\.]+)",j+=")",i&&(j+="?"),j}),new RegExp("^"+a+"$",b?"":"i")))},b}(Tower.Class),Tower.Route=Tower.HTTP.Route,Tower.HTTP.Route.DSL=function(){function a(){this._scope={}}return a.prototype.match=function(){return this.scope||(this.scope={}),Tower.HTTP.Route.create(new Tower.HTTP.Route(this._extractOptions.apply(this,arguments)))},a.prototype.get=function(){return this.matchMethod("get",Tower.Support.Array.args(arguments))},a.prototype.post=function(){return this.matchMethod("post",Tower.Support.Array.args(arguments))},a.prototype.put=function(){return this.matchMethod("put",Tower.Support.Array.args(arguments))},a.prototype["delete"]=function(){return this.matchMethod("delete",Tower.Support.Array.args(arguments))},a.prototype.matchMethod=function(a,b){var c,d,e;return typeof b[b.length-1]=="object"?d=b.pop():d={},c=b.shift(),d.method=a,d.action=c,d.name=c,this._scope.name&&(d.name=this._scope.name+Tower.Support.String.camelize(d.name)),e="/"+c,this._scope.path&&(e=this._scope.path+e),this.match(e,d),this},a.prototype.scope=function(a,b){var c;return a==null&&(a={}),c=this._scope||(this._scope={}),this._scope=Tower.Support.Object.extend({},c,a),b.call(this),this._scope=c,this},a.prototype.controller=function(a,b,c){return b.controller=a,this.scope(b,c)},a.prototype.namespace=function(a,b,c){return typeof b=="function"?(c=b,b={}):b={},b=Tower.Support.Object.extend({name:a,path:a,as:a,module:a,shallowPath:a,shallowPrefix:a},b),b.name&&this._scope.name&&(b.name=this._scope.name+Tower.Support.String.camelize(b.name)),this.scope(b,c)},a.prototype.constraints=function(a,b){return this.scope({constraints:a},b)},a.prototype.defaults=function(a,b){return this.scope({defaults:a},b)},a.prototype.resource=function(a,b){return b==null&&(b={}),b.controller=a,this.match(""+a+"/new",Tower.Support.Object.extend({action:"new"},b)),this.match(""+a,Tower.Support.Object.extend({action:"create",method:"POST"},b)),this.match(""+a+"/",Tower.Support.Object.extend({action:"show"},b)),this.match(""+a+"/edit",Tower.Support.Object.extend({action:"edit"},b)),this.match(""+a,Tower.Support.Object.extend({action:"update",method:"PUT"},b)),this.match(""+a,Tower.Support.Object.extend({action:"destroy",method:"DELETE"},b))},a.prototype.resources=function(a,b,c){var d,e,f;return typeof b=="function"?(c=b,b={}):b={},b.controller||(b.controller=a),f="/"+a,this._scope.path&&(f=this._scope.path+f),this._scope.name?d=this._scope.name+Tower.Support.String.camelize(a):d=a,e=Tower.Support.String.singularize(d),this.match(""+f,Tower.Support.Object.extend({name:""+d,action:"index"},b)),this.match(""+f+"/new",Tower.Support.Object.extend({name:"new"+Tower.Support.String.camelize(e),action:"new"},b)),this.match(""+f,Tower.Support.Object.extend({action:"create",method:"POST"},b)),this.match(""+f+"/:id",Tower.Support.Object.extend({name:""+e,action:"show"},b)),this.match(""+f+"/:id/edit",Tower.Support.Object.extend({name:"edit"+Tower.Support.String.camelize(e),action:"edit"},b)),this.match(""+f+"/:id",Tower.Support.Object.extend({action:"update",method:"PUT"},b)),this.match(""+f+"/:id",Tower.Support.Object.extend({action:"destroy",method:"DELETE"},b)),c&&this.scope(Tower.Support.Object.extend({path:""+f+"/:"+Tower.Support.String.singularize(a)+"Id",name:e},b),c),this},a.prototype.collection=function(){},a.prototype.member=function(){},a.prototype.root=function(a){return this.match("/",Tower.Support.Object.extend({as:"root"},a))},a.prototype._extractOptions=function(){var a,b,c,d,e,f,g,h,i,j;return b=Tower.Support.Array.args(arguments),j="/"+b.shift().replace(/^\/|\/$/,""),typeof b[b.length-1]=="object"?i=b.pop():i={},b.length>0&&(i.to||(i.to=b.shift())),i.path=j,f=this._extractFormat(i),i.path=this._extractPath(i),g=this._extractRequestMethod(i),c=this._extractConstraints(i),e=this._extractDefaults(i),d=this._extractController(i),a=this._extractAnchor(i),h=this._extractName(i),i=Tower.Support.Object.extend(i,{method:g,constraints:c,defaults:e,name:h,format:f,controller:d,anchor:a,ip:i.ip}),i},a.prototype._extractFormat=function(a){},a.prototype._extractName=function(a){return a.as||a.name},a.prototype._extractConstraints=function(a){return Tower.Support.Object.extend(this._scope.constraints||{},a.constraints||{})},a.prototype._extractDefaults=function(a){return a.defaults||{}},a.prototype._extractPath=function(a){return""+a.path+".:format?"},a.prototype._extractRequestMethod=function(a){return(a.method||a.via||"GET").toUpperCase()},a.prototype._extractAnchor=function(a){return a.anchor},a.prototype._extractController=function(a){var b,c,d;a==null&&(a={}),d=a.to,d&&(d=d.split("#"),d.length===1?b=d[0]:(c=d[0],b=d[1])),c||(c=a.controller||this._scope.controller),b||(b=a.action);if(!c)throw new Error("No controller was specified for the route "+a.path);return c=c.toLowerCase().replace(/(?:[cC]ontroller)?$/,"Controller"),{name:c,action:b,className:Tower.Support.String.camelize(""+c)}},a}(),Tower.HTTP.Route.Urls={ClassMethods:{urlFor:function(a){var b,c,d,e,f;switch(typeof a){case"string":return a;default:return d=a.controller,b=a.action,e=a.host,f=a.port,c=a.anchor,a}}}},Tower.HTTP.Route.PolymorphicUrls={ClassMethods:{polymorphicUrl:function(){}}},Tower.HTTP.Route.include(Tower.HTTP.Route.Urls),Tower.HTTP.Route.include(Tower.HTTP.Route.PolymorphicUrls),Tower.HTTP.Request=function(){function a(a){a==null&&(a={}),this.url=a.url,this.location=a.location,this.pathname=this.location.path,this.query=this.location.query,this.title=a.title,this.title||(this.title=typeof document!="undefined"&&document!==null?document.title:void 0),this.body=a.body||{},this.headers=a.headers||{},this.method=a.method||"GET"}return a}(),Tower.HTTP.Response=function(){function a(a){a==null&&(a={}),this.url=a.url,this.location=a.location,this.pathname=this.location.path,this.query=this.location.query,this.title=a.title,this.title||(this.title=typeof document!="undefined"&&document!==null?document.title:void 0),this.body=a.body||{},this.headers=a.headers||{},this.headerSent=!1,this.statusCode=200,this.body=""}return a.prototype.writeHead=function(a,b){return this.statusCode=a,this.headers=b},a.prototype.setHeader=function(a,b){if(this.headerSent)throw new Error("Headers already sent");return this.headers[a]=b},a.prototype.write=function(a){return a==null&&(a=""),this.body+=a},a.prototype.end=function(a){return a==null&&(a=""),this.body+=a,this.sent=!0,this.headerSent=!0},a.prototype.redirect=function(a,b){b==null&&(b={});if(global.History)return global.History.push(b,null,a)},a}(),Tower.HTTP.Url=function(){function a(a,b,c){b==null&&(b=1),this.strictMode=c||!1,this.depth=b||1,typeof window!="undefined"&&window!==null&&(this.url=a||(a=window.location.toString())),this.parse(a)}return a.key=["source","protocol","host","userInfo","user","password","hostname","port","relative","path","directory","file","query","fragment"],a.aliases={anchor:"fragment"},a.parser={strict:/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*):?([^:@]*))?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,loose:/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*):?([^:@]*))?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/},a.querystringParser=/(?:^|&|;)([^&=;]*)=?([^&;]*)/g,a.fragmentParser=/(?:^|&|;)([^&=;]*)=?([^&;]*)/g,a.typeParser=/(youtube|vimeo|eventbrite)/,a.prototype.parse=function(a){var b,c,d,e,f,g,h,i;f=this.constructor.key,a=decodeURI(a),h=this.constructor.parser[this.strictMode||!1?"strict":"loose"].exec(a),b={},this.params=g={},this.fragment=d={params:{}},e=14;while(e--)b[f[e]]=h[e]||"";b.query.replace(this.constructor.querystringParser,function(a,b,c){if(b)return g[b]=c}),b.fragment.replace(this.constructor.fragmentParser,function(a,b,c){if(b)return d.params[b]=c}),this.segments=b.path.replace(/^\/+|\/+$/g,"").split("/"),d.segments=b.fragment.replace(/^\/+|\/+$/g,"").split("/");for(f in b)i=b[f],this[f]||(this[f]=i);this.root=b.host?b.protocol+"://"+b.hostname+(b.port?":"+b.port:""):"",c=this.hostname.split("."),this.domain=c.slice(c.length-1-this.depth,c.length-1+1||9e9).join("."),this.subdomains=c.slice(0,c.length-2-this.depth+1||9e9),this.subdomain=this.subdomains.join(".");if(this.port!=null)return this.port=parseInt(this.port)},a}(),Tower.Middleware={},Tower.Middleware.Agent=function(a,b,c){var d,e;d=require("useragent").parse(a.headers["user-agent"]),e=Tower.Support.Object.extend(require("useragent").is(a.headers["user-agent"]),{family:d.family,major:d.major,minor:d.minor,patch:d.patch,version:d.toVersion(),os:d.os,name:d.toAgent(),mac:!!d.os.match(/mac/i),windows:!!d.os.match(/win/i),linux:!!d.os.match(/linux/i)}),a.agent=new Tower.HTTP.Agent(e);if(c)return c()},Tower.Middleware.Cookies=function(a,b,c){return a._cookies||(a._cookies=Tower.HTTP.Cookies.parse())},Tower.Middleware.Location=function(a,b,c){var d;return a.location||(a.url.match(/^http/)?d=a.url:d="http://"+a.headers.host+a.url,a.location=new Tower.HTTP.Url(d)),c()},Tower.Middleware.Router=function(a,b,c){return Tower.Middleware.Router.find(a,b,function(c){return c?(b.controller=c,b.writeHead(c.status,c.headers),b.write(c.body),b.end(),c.clear()):Tower.Middleware.Router.error(a,b)}),b},Tower.Support.Object.extend(Tower.Middleware.Router,{find:function(a,b,c){return this.processHost(a,b),this.processAgent(a,b),Tower.HTTP.Route.findController(a,b,c)},processHost:function(a,b){return a.location||(a.location=new Tower.HTTP.Url(a.url))},processAgent:function(a,b){if(a.headers)return a.userAgent||(a.userAgent=a.headers["user-agent"])},error:function(a,b){if(b)return b.statusCode=404,b.setHeader("Content-Type","text/plain"),b.end("No path matches "+a.url)}})})).call(this)